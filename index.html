<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check Prononciation Avec Ann</title>
  <link rel="icon" href="favicon.png" type="image/png">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body { height: 100%; width: 100%; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('bg.jpg') no-repeat center center fixed; 
      background-size: cover;
      display: flex; flex-direction: column; overflow: hidden; color: #fff;
    }

    .overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); z-index: 0;
    }

    .app-container {
      width: 100%; height: 100%; display: flex; flex-direction: column;
      padding: 24px; position: relative; z-index: 1;
    }

    .header { text-align: center; margin-bottom: 10px; flex-shrink: 0; }

    .header h1 {
      color: #fff; font-size: 30px; font-weight: 800; text-transform: uppercase;
      text-shadow: 0 0 5px #fff, 0 0 20px #ff00de; margin-bottom: 5px;
      letter-spacing: 1px;
    }

    .slogan {
      font-size: 14px; font-weight: 600; background: rgba(0, 0, 0, 0.7);
      display: inline-block; padding: 5px 15px; border-radius: 50px;
      border: 1px solid #00ffea; color: #00ffea;
    }

    .main-content {
      flex: 1; display: flex; flex-direction: column;
      max-width: 900px; width: 100%; margin: 0 auto; min-height: 0;
    }

    .text-display-wrapper {
      flex: 1; background: rgba(255, 255, 255, 0.95);
      border-radius: 16px; 
      overflow: hidden; 
      margin-bottom: 15px; position: relative;
      border: 2px solid rgba(255,255,255,0.2);
      display: flex; flex-direction: column;
    }

    .text-display {
      flex: 1; position: relative; padding: 0 40px; overflow-y: hidden; display: block; 
    }

    .text-display.review-mode {
      overflow-y: auto; padding-top: 20px; padding-bottom: 20px;
    }

    #content-wrapper {
      width: 100%; text-align: justify;
      position: absolute; top: 100%; left: 0; right: 0;
      padding-bottom: 100px;
    }

    .review-mode #content-wrapper {
      position: relative; top: 0 !important; transform: none !important; animation: none !important;
    }

    .scrolling { animation: scrollUp 60s linear forwards; }
    @keyframes scrollUp { 
      from { top: 100%; transform: translateY(0); } 
      to { top: 0; transform: translateY(-100%); } 
    }

    .word {
      display: inline-block; font-size: 24px; line-height: 1.8;
      padding: 0 2px; border-radius: 4px; color: #333; margin-right: 4px;
    }
    .word.correct { background-color: #48bb78; color: #fff; border-bottom: 2px solid #2f855a; }
    .word.wrong { color: #e53e3e; text-decoration: line-through; opacity: 0.5; }

    .controls {
      display: flex; gap: 15px; align-items: center; justify-content: center;
      background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 16px; flex-shrink: 0;
    }

    .btn {
      padding: 12px 24px; font-size: 16px; font-weight: bold; border: none; border-radius: 50px;
      cursor: pointer; transition: 0.2s; min-width: 130px;
    }
    .btn-main { background: #fbbf24; color: #744210; }
    .btn-main:hover { background: #fff; }
    .btn-next { background: #63b3ed; color: #fff; }
    
    .timer { font-size: 24px; font-weight: 700; color: #fff; min-width: 70px; text-align: center; }

    .result-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 2000; display: none;
      align-items: center; justify-content: center;
    }
    .result-modal.active { display: flex; }
    .result-box {
      background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 450px;
      border: 4px solid #ccc;
    }
    .result-score { font-size: 60px; font-weight: 900; margin: 15px 0; }
    .result-msg { font-size: 22px; font-weight: 600; line-height: 1.4; margin-bottom: 20px; color: #333; }
    
    .french-mode .result-box { border-color: #48bb78; box-shadow: 0 0 30px #48bb78; }
    .french-mode .result-score { color: #48bb78; }
    .french-mode .result-msg { color: #2f855a; }
    
    .chicken-mode .result-box { border-color: #ff4757; box-shadow: 0 0 30px #ff4757; }
    .chicken-mode .result-score { color: #ff4757; }
    .chicken-mode .result-msg { color: #c53030; }

    .btn-close { background: #333; color: white; padding: 10px 25px; border-radius: 50px; border: none; cursor: pointer; margin-top: 15px; }
    
    .topic-badge {
      position: absolute; top: 10px; left: 10px; 
      background: #333; color: #fff; padding: 4px 10px; 
      border-radius: 4px; font-size: 12px; z-index: 10;
      text-transform: uppercase; letter-spacing: 1px;
    }
    #debugInfo {
        position: fixed; bottom: 5px; left: 5px; 
        font-size: 10px; color: rgba(255,255,255,0.5); 
        max-width: 300px; z-index: 2001; pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="overlay"></div>
  
  <div class="app-container">
    <header class="header">
      <h1>CHECK PRONONCIATION AVEC ANN</h1>
      <div class="slogan">ü§µ B·∫°n l√† ng∆∞·ªùi Ph√°p hay l√† con g√†e? üêî</div>
    </header>

    <main class="main-content">
      <div class="text-display-wrapper">
        <div class="topic-badge" id="topicDisplay">Topic</div>
        <div class="timer" id="timer" style="position: absolute; top: 10px; right: 10px; color: #333; z-index: 10;">01:00</div>
        
        <div class="text-display" id="textDisplayArea">
          <div id="content-wrapper"></div>
        </div>
      </div>

      <div class="controls">
        <button id="mainBtn" class="btn btn-main">D√©marrer (B·∫Øt ƒë·∫ßu)</button>
        <button id="nextBtn" class="btn btn-next">B√†i kh√°c (Autres) ></button>
      </div>
    </main>
  </div>
  
  <div id="debugInfo"></div>

  <div class="result-modal" id="resultModal">
    <div class="result-box">
      <h2>K·∫æT QU·∫¢</h2>
      <div class="result-score" id="modalScore">0%</div>
      <div class="result-msg" id="modalMsg">...</div>
      <button class="btn-close" onclick="closeResult()">Xem l·∫°i l·ªói sai</button>
    </div>
  </div>

  <script>
    // ==========================================
    // D·ªÆ LI·ªÜU B√ÄI ƒê·ªåC
    // ==========================================
    const readingLibrary = [
      { topic: "Kh√°m ph√° Paris", text: "Paris est souvent appel√©e la ville lumi√®re, et pour cause. Quand le soleil se couche, les monuments s'illuminent et cr√©ent une atmosph√®re magique et romantique. Se promener sur les quais de la Seine est une exp√©rience inoubliable pour les touristes du monde entier. On peut admirer la cath√©drale Notre-Dame, le mus√©e du Louvre et bien s√ªr, la majestueuse tour Eiffel qui brille dans la nuit. Mais Paris, ce n'est pas seulement des monuments. C'est aussi l'odeur du caf√© frais le matin, les boulangeries qui vendent des croissants chauds et les artistes qui peignent dans les rues de Montmartre. C'est une ville qui vit, qui respire et qui inspire les po√®tes depuis des si√®cles." },
      { topic: "Ngh·ªá thu·∫≠t s·ªëng", text: "En France, la gastronomie est bien plus qu'une simple fa√ßon de se nourrir, c'est un v√©ritable art de vivre. Le repas est un moment sacr√© o√π la famille et les amis se r√©unissent pour partager du bonheur et des discussions anim√©es. On prend le temps de d√©guster chaque plat, de l'entr√©e au dessert, accompagn√© souvent d'un verre de vin rouge ou blanc. Les march√©s locaux regorgent de produits frais : des fromages vari√©s, des l√©gumes color√©s et des fruits d√©licieux. Cuisiner est un acte d'amour et de tradition. Chaque r√©gion poss√®de ses propres sp√©cialit√©s et ses secrets culinaires qui se transmettent de g√©n√©ration en g√©n√©ration avec fiert√©." },
      { topic: "L·ª£i √≠ch c·ªßa vi·ªác ƒë·ªçc s√°ch", text: "Dans notre monde moderne domin√© par les √©crans et la technologie, prendre le temps de lire un livre est devenu un luxe pr√©cieux. La lecture nous permet de voyager sans bouger de notre fauteuil. Elle ouvre notre esprit √† de nouvelles id√©es, enrichit notre vocabulaire et stimule notre imagination. Quand on lit un roman, on vit mille vies diff√©rentes, on ressent les √©motions des personnages et on oublie nos propres soucis quotidiens. Que ce soit de la po√©sie, de la science-fiction ou de l'histoire, chaque livre est une porte ouverte vers un autre univers. C'est une habitude qui calme l'esprit et nourrit l'√¢me en profondeur." },
      { topic: "B·∫£o v·ªá thi√™n nhi√™n", text: "La nature nous offre tout ce dont nous avons besoin pour vivre : l'air que nous respirons, l'eau que nous buvons et la nourriture que nous mangeons. Cependant, l'activit√© humaine menace aujourd'hui cet √©quilibre fragile. Les for√™ts disparaissent, les oc√©ans sont pollu√©s et le climat change rapidement. Il est urgent de changer nos habitudes pour prot√©ger notre belle plan√®te bleue. Des gestes simples peuvent faire une grande diff√©rence, comme r√©duire notre consommation de plastique, recycler nos d√©chets ou utiliser les transports en commun. Prot√©ger l'environnement, ce n'est pas seulement sauver les animaux, c'est aussi assurer un avenir sain et heureux pour nos enfants et les g√©n√©rations futures." },
      { topic: "Gi√° tr·ªã c·ªßa t√¨nh b·∫°n", text: "On dit souvent que les amis sont la famille que l'on choisit. Une amiti√© v√©ritable est l'une des choses les plus pr√©cieuses dans la vie d'une personne. Un vrai ami est quelqu'un qui est l√† pour vous dans les moments difficiles, qui vous √©coute sans vous juger et qui partage vos joies comme vos peines. Avec le temps et la distance, il est parfois difficile de garder le contact, mais les liens forts r√©sistent √† tout. Ce n'est pas la quantit√© d'amis qui compte, mais la qualit√©. Avoir une personne sur qui compter, avec qui rire et pleurer, est un cadeau inestimable qui rend la vie beaucoup plus douce." },
      { topic: "Du l·ªãch v√† tr·∫£i nghi·ªám", text: "Voyager est la meilleure √©cole de la vie. Quand on visite un pays √©tranger, on ne d√©couvre pas seulement de nouveaux paysages, on d√©couvre aussi une nouvelle fa√ßon de penser et de vivre. On apprend √† sortir de sa zone de confort, √† go√ªter des aliments inconnus et √† essayer de parler une autre langue. Ces exp√©riences nous rendent plus ouverts, plus tol√©rants et plus humbles. On r√©alise que malgr√© nos diff√©rences culturelles, les √™tres humains partagent les m√™mes r√™ves et les m√™mes √©motions partout sur la Terre. Le voyage nous change int√©rieurement et nous laisse des souvenirs grav√©s √† jamais dans notre m√©moire." },
      { topic: "Th·ªÉ thao v√† s·ª©c kh·ªèe", text: "Le sport joue un r√¥le essentiel pour maintenir une bonne sant√© physique et mentale. Pratiquer une activit√© physique r√©guli√®re aide √† r√©duire le stress, √† am√©liorer le sommeil et √† renforcer le c≈ìur. Que ce soit la course √† pied, la natation, le yoga ou le football, l'important est de bouger et de se faire plaisir. Le sport nous apprend aussi des valeurs importantes comme la discipline, le respect des r√®gles et l'esprit d'√©quipe. Se d√©passer, fixer des objectifs et voir ses progr√®s procure une grande satisfaction personnelle. Comme on dit souvent : un esprit sain dans un corps sain est la cl√© du bonheur." },
      { topic: "C√¥ng ngh·ªá v√† cu·ªôc s·ªëng", text: "La technologie a transform√© notre fa√ßon de vivre √† une vitesse incroyable. Aujourd'hui, nous pouvons communiquer instantan√©ment avec des personnes √† l'autre bout du monde, acc√©der √† toute la connaissance humaine en un clic et travailler depuis n'importe o√π. Cependant, cette connexion permanente a aussi ses inconv√©nients. Nous passons parfois plus de temps √† regarder nos t√©l√©phones qu'√† parler aux gens qui sont en face de nous. Il est important de trouver un √©quilibre. La technologie doit rester un outil pour nous servir, et non un ma√Ætre qui contr√¥le notre temps et notre attention. Savoir se d√©connecter est devenu une comp√©tence essentielle." },
      { topic: "H·∫°nh ph√∫c t·ª´ ƒëi·ªÅu gi·∫£n ƒë∆°n", text: "Beaucoup de gens cherchent le bonheur dans la richesse, la c√©l√©brit√© ou la r√©ussite professionnelle. Pourtant, le vrai bonheur se cache souvent dans les choses simples de la vie quotidienne. C'est l'odeur de la pluie en √©t√©, le sourire d'un enfant, un repas partag√© avec des proches ou une promenade tranquille dans la for√™t. Savoir appr√©cier l'instant pr√©sent est un secret que nous oublions trop souvent. La gratitude est une cl√© puissante : √™tre reconnaissant pour ce que l'on a, au lieu de toujours d√©sirer ce que l'on n'a pas. Le bonheur n'est pas une destination √† atteindre, c'est une mani√®re de voyager chaque jour." },
      { topic: "Gi·∫•c m∆° v√† n·ªó l·ª±c", text: "Avoir des r√™ves est ce qui donne un sens √† notre existence. Que ce soit devenir m√©decin, voyager autour du monde, √©crire un livre ou simplement fonder une famille heureuse, nos r√™ves nous poussent √† avancer. Mais r√™ver ne suffit pas, il faut aussi avoir le courage d'agir. Le chemin vers le succ√®s est souvent rempli d'obstacles et d'√©checs. Ce n'est pas grave de tomber, l'important est de se relever et de continuer √† essayer. La pers√©v√©rance et le travail acharn√© sont les cl√©s de la r√©ussite. Ne laissez jamais personne vous dire que vos r√™ves sont impossibles, car votre potentiel est infini." }
    ];

    // ==========================================
    // LOGIC H·ªÜ TH·ªêNG
    // ==========================================
    
    // T·∫†O UNIQUE SESSION ID CHO M·ªñI BROWSER/TAB (tr√°nh conflict khi nhi·ªÅu ng∆∞·ªùi d√πng)
    // S·ª≠ d·ª•ng crypto.randomUUID() n·∫øu c√≥, n·∫øu kh√¥ng th√¨ d√πng timestamp + random
    const UNIQUE_SESSION_PREFIX = typeof crypto !== 'undefined' && crypto.randomUUID 
      ? crypto.randomUUID() 
      : `${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
    let sessionCounter = 0;
    
    let currentIdx = 0;
    let mediaRecorder = null;
    let fullTranscript = "";
    
    // Qu·∫£n l√Ω Timer & Interval
    let timerInterval = null;
    let chunkInterval = null;
    let resultTimeout = null;
    
    const TIME_LIMIT = 60;
    let timeLeft = TIME_LIMIT;
    let streamReference = null;
    let currentSessionId = `${UNIQUE_SESSION_PREFIX}-${++sessionCounter}`;
    
    // DOM Elements
    const contentWrapper = document.getElementById('content-wrapper');
    const textDisplayArea = document.getElementById('textDisplayArea');
    const mainBtn = document.getElementById('mainBtn');
    const nextBtn = document.getElementById('nextBtn');
    const timerDisplay = document.getElementById('timer');
    const topicDisplay = document.getElementById('topicDisplay');
    const resultModal = document.getElementById('resultModal');
    const modalScore = document.getElementById('modalScore');
    const modalMsg = document.getElementById('modalMsg');
    const debugInfo = document.getElementById('debugInfo');

    // --- H√ÄM 1: D·ª™NG TO√ÄN B·ªò TIMER (KILL SWITCH) ---
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    // --- H√ÄM 2: D·ªåN S·∫†CH D·ªÆ LI·ªÜU C≈® (NUCLEAR RESET) ---
    function nuclearReset() {
       stopTimer(); // D·ª´ng ƒë·ªìng h·ªì tr∆∞·ªõc ti√™n
       
       if (chunkInterval) clearInterval(chunkInterval);
       if (resultTimeout) clearTimeout(resultTimeout);
       
       chunkInterval = null;
       resultTimeout = null;
       
       // T·∫°o ID phi√™n m·ªõi (unique cho m·ªói browser/tab)
       currentSessionId = `${UNIQUE_SESSION_PREFIX}-${++sessionCounter}`; 
       
       // X√≥a transcript
       fullTranscript = "";
       debugInfo.textContent = "";
       
      // D·ª´ng Mic - x√≥a event handler tr∆∞·ªõc ƒë·ªÉ tr√°nh race condition
      if(mediaRecorder) {
        // X√≥a event handler ƒë·ªÉ tr√°nh onstop ƒë∆∞·ª£c g·ªçi sau khi reset
        mediaRecorder.onstop = null;
        mediaRecorder.ondataavailable = null;
        
        if(mediaRecorder.state !== 'inactive') {
          try { 
            mediaRecorder.stop(); 
          } catch(e){
            console.error('Error stopping MediaRecorder in reset:', e);
          }
        }
      }
      mediaRecorder = null;
       
       if(streamReference) {
         try { streamReference.getTracks().forEach(track => track.stop()); } catch(e){}
         streamReference = null;
       }
       
       // Reset UI
       mainBtn.disabled = false;
       mainBtn.textContent = "D√©marrer (B·∫Øt ƒë·∫ßu)";
       mainBtn.classList.remove('btn-retry');
       mainBtn.classList.add('btn-main');
       
       // Reset animation v√† position c·ªßa content-wrapper
       contentWrapper.classList.remove('scrolling');
       // Quan tr·ªçng: Reset v·ªÅ v·ªã tr√≠ ban ƒë·∫ßu (top: 100%) ƒë·ªÉ tr√°nh text hi·ªán ·ªü gi·ªØa
       // Ch·ªâ set top, kh√¥ng set animation ƒë·ªÉ khi b·∫Øt ƒë·∫ßu animation v·∫´n ch·∫°y ƒë∆∞·ª£c
       contentWrapper.style.top = '100%';
       contentWrapper.style.transform = '';
       contentWrapper.style.animation = '';
       
       // Reset result modal
       resultModal.className = 'result-modal';
       resultModal.style.display = 'none';
       resultModal.classList.remove('active', 'french-mode', 'chicken-mode');
       textDisplayArea.classList.remove('review-mode');
       
       // Reset hi·ªÉn th·ªã ƒë·ªìng h·ªì v·ªÅ 60s ngay l·∫≠p t·ª©c
       timeLeft = TIME_LIMIT;
       timerDisplay.textContent = "01:00";
    }

    function loadText(index) {
      nuclearReset(); 
      
      const data = readingLibrary[index];
      topicDisplay.textContent = data.topic;
      const words = data.text.trim().split(/\s+/);
      contentWrapper.innerHTML = '';
      words.forEach(word => {
        const span = document.createElement('span');
        span.className = 'word';
        span.textContent = word;
        span.dataset.clean = normalizeWord(word); 
        contentWrapper.appendChild(span);
      });
      
      // Reset CSS v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
      textDisplayArea.className = 'text-display';
      textDisplayArea.classList.remove('review-mode');
      contentWrapper.className = '';
      
      // QUAN TR·ªåNG: ƒê·∫£m b·∫£o content-wrapper v·ªÅ v·ªã tr√≠ ban ƒë·∫ßu (tr√°nh text hi·ªán ·ªü gi·ªØa)
      // Ch·ªâ set top, kh√¥ng set animation ƒë·ªÉ khi b·∫Øt ƒë·∫ßu animation v·∫´n ch·∫°y ƒë∆∞·ª£c
      contentWrapper.style.top = '100%';
      contentWrapper.style.transform = '';
      contentWrapper.style.animation = '';
      
      // Reset result modal state
      resultModal.className = 'result-modal';
      resultModal.style.display = 'none';
      resultModal.classList.remove('active', 'french-mode', 'chicken-mode');
    }

    function normalizeWord(word) {
      return word.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "").replace(/\s+/g, "");
    }

    // --- X·ª¨ L√ù N√öT B·∫§M ---
    mainBtn.addEventListener('click', async () => {
      if (mainBtn.classList.contains('btn-retry')) {
        loadText(currentIdx);
        return; 
      }
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        streamReference = stream;
        startSession(stream);
      } catch (err) {
        alert("L·ªói Micro: " + err.message);
      }
    });

    nextBtn.addEventListener('click', () => {
      nuclearReset();
      randomizeLesson();
    });

    function randomizeLesson() {
      let newIdx;
      do { newIdx = Math.floor(Math.random() * readingLibrary.length); } 
      while (newIdx === currentIdx && readingLibrary.length > 1);
      currentIdx = newIdx;
      loadText(currentIdx);
    }

    function startSession(stream) {
      stopTimer(); // ƒê·∫£m b·∫£o kh√¥ng c√≥ timer n√†o ƒëang ch·∫°y
      
      // *** FIX QUAN TR·ªåNG: RESET TIME NGAY T·∫†I ƒê√ÇY ***
      timeLeft = TIME_LIMIT; 
      timerDisplay.textContent = "01:00";
      
      const sessionForThisRecorder = currentSessionId; 
      
      mainBtn.disabled = true;
      mainBtn.textContent = "ƒêang nghe...";
      
      // X√≥a inline style ƒë·ªÉ animation c√≥ th·ªÉ ho·∫°t ƒë·ªông
      contentWrapper.style.top = '';
      contentWrapper.style.transform = '';
      contentWrapper.style.animation = '';
      
      // Reset v·ªÅ v·ªã tr√≠ ban ƒë·∫ßu tr∆∞·ªõc khi add animation
      // Force reflow ƒë·ªÉ ƒë·∫£m b·∫£o style ƒë∆∞·ª£c apply
      contentWrapper.offsetHeight;
      contentWrapper.classList.add('scrolling');
      
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) sendToOpenAI(e.data, sessionForThisRecorder);
      };

      // X·ª≠ l√Ω khi MediaRecorder d·ª´ng ƒë·ªÉ restart an to√†n
      mediaRecorder.onstop = () => {
        // Ki·ªÉm tra k·ªπ: mediaRecorder v·∫´n t·ªìn t·∫°i, session v·∫´n h·ª£p l·ªá, v√† stream v·∫´n active
        if (!mediaRecorder || currentSessionId !== sessionForThisRecorder) {
          return; // Session ƒë√£ thay ƒë·ªïi, kh√¥ng restart
        }
        
        // Ch·ªâ restart n·∫øu v·∫´n c√≤n th·ªùi gian v√† stream v·∫´n c√≤n active
        if (timeLeft > 0 && streamReference && streamReference.active) {
          // ƒê·∫£m b·∫£o MediaRecorder ƒë√£ ·ªü tr·∫°ng th√°i inactive tr∆∞·ªõc khi start l·∫°i
          if (mediaRecorder.state === 'inactive') {
            try {
              mediaRecorder.start();
            } catch (e) {
              console.error('Error restarting MediaRecorder:', e);
              // N·∫øu kh√¥ng restart ƒë∆∞·ª£c, c√≥ th·ªÉ stream ƒë√£ b·ªã ƒë√≥ng
            }
          }
        }
      };

      mediaRecorder.start();

      // Chunking 4s - ch·ªâ stop, restart s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong onstop
      chunkInterval = setInterval(() => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          // Ki·ªÉm tra session v·∫´n h·ª£p l·ªá tr∆∞·ªõc khi stop
          if (timeLeft > 0 && currentSessionId === sessionForThisRecorder) {
            try {
              mediaRecorder.stop();
            } catch (e) {
              console.error('Error stopping MediaRecorder:', e);
            }
          } else {
            // N·∫øu h·∫øt th·ªùi gian ho·∫∑c session kh√¥ng h·ª£p l·ªá, d·ª´ng lu√¥n
            if (mediaRecorder.state === 'recording') {
              try {
                mediaRecorder.stop();
              } catch (e) {
                console.error('Error stopping MediaRecorder:', e);
              }
            }
          }
        }
      }, 4000);

      // *** TIMER LOGIC AN TO√ÄN ***
      timerInterval = setInterval(() => {
        timeLeft--;
        
        // Hi·ªÉn th·ªã: N·∫øu < 0 th√¨ v·∫´n hi·ªán 00 ƒë·ªÉ m·∫Øt kh√¥ng b·ªã kh√≥ ch·ªãu
        const displayTime = Math.max(0, timeLeft);
        timerDisplay.textContent = `00:${displayTime < 10 ? '0'+displayTime : displayTime}`;
        
        if (timeLeft <= 0) {
            stopTimer(); // D·ª´ng ƒë·∫øm ngay
            finishSession();
        }
      }, 1000);
    }

    async function sendToOpenAI(blob, sessionId) {
      if (sessionId !== currentSessionId) return;
      if (blob.size < 1000) return;

      const formData = new FormData();
      formData.append('audio', blob, 'chunk.webm');
      try {
        const res = await fetch('/api/transcribe', { method: 'POST', body: formData });
        const data = await res.json();
        
        if (sessionId !== currentSessionId) return;

        if (data.text) {
            fullTranscript += " " + data.text;
            debugInfo.textContent = "Listening: " + fullTranscript.substring(Math.max(0, fullTranscript.length - 50));
        }
      } catch (e) { console.error(e); }
    }

    function finishSession() {
      stopTimer();
      if (chunkInterval) clearInterval(chunkInterval);
      
      // D·ª´ng MediaRecorder an to√†n - x√≥a handler ƒë·ªÉ tr√°nh restart
      if (mediaRecorder) {
        mediaRecorder.onstop = null; // NgƒÉn kh√¥ng cho restart
        if (mediaRecorder.state !== 'inactive') {
          try {
            mediaRecorder.stop();
          } catch (e) {
            console.error('Error stopping MediaRecorder in finishSession:', e);
          }
        }
      }
      
      if (streamReference) {
        try {
          streamReference.getTracks().forEach(track => track.stop());
        } catch (e) {
          console.error('Error stopping stream tracks:', e);
        }
      }
      
      mainBtn.disabled = true;
      mainBtn.textContent = "ƒêang ch·∫•m ƒëi·ªÉm...";
      
      // Clear any existing timeout first
      if (resultTimeout) clearTimeout(resultTimeout);
      
      resultTimeout = setTimeout(() => {
          // Double check that we're still in scoring state and have words to score
          if(mainBtn.textContent === "ƒêang ch·∫•m ƒëi·ªÉm..." && document.querySelectorAll('.word').length > 0) {
              calculateResult();
          }
      }, 3000); 
    }

    function calculateResult() {
      // Clear any pending timeout
      if (resultTimeout) {
        clearTimeout(resultTimeout);
        resultTimeout = null;
      }
      
      const spokenWordsArray = fullTranscript.toLowerCase().split(/\s+/).map(w => normalizeWord(w));
      const domWords = document.querySelectorAll('.word');
      
      // Reset all word classes first to ensure clean state
      domWords.forEach(span => {
        span.classList.remove('correct', 'wrong');
      });
      
      let correctCount = 0;

      domWords.forEach(span => {
        const targetWord = span.dataset.clean;
        const foundIndex = spokenWordsArray.indexOf(targetWord);

        if (foundIndex !== -1) {
          span.classList.add('correct');
          correctCount++;
          spokenWordsArray.splice(foundIndex, 1);
        } else {
          span.classList.add('wrong');
        }
      });

      const score = Math.round((correctCount / domWords.length) * 100) || 0;

      resultModal.className = 'result-modal active';
      resultModal.style.display = 'flex';
      resultModal.classList.remove('french-mode', 'chicken-mode');
      
      if (score >= 50) {
        resultModal.classList.add('french-mode');
        modalMsg.innerHTML = "Ch√∫c m·ª´ng, b·∫°n l√† ng∆∞·ªùi Ph√°p üá´üá∑üç∑";
      } else {
        resultModal.classList.add('chicken-mode');
        modalMsg.innerHTML = "L√™u l√™u, b·∫°n l√† con g√†e üêîü§£";
      }
      modalScore.textContent = `${score}%`;

      mainBtn.disabled = false;
      mainBtn.textContent = "üîÑ L√†m l·∫°i";
      mainBtn.classList.add('btn-retry');
      mainBtn.classList.remove('btn-main');
    }

    function closeResult() {
      resultModal.style.display = 'none';
      textDisplayArea.classList.add('review-mode');
    }

    window.onload = function() { randomizeLesson(); };
  </script>
</body>
</html>
