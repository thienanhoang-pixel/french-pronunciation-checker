<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check Prononciation Avec Ann</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body { height: 100%; width: 100%; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; flex-direction: column; overflow: hidden; color: #fff;
    }

    .overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.3); z-index: 0;
    }

    .app-container {
      width: 100%; height: 100%; display: flex; flex-direction: column;
      padding: 24px; position: relative; z-index: 1;
    }

    .header { text-align: center; margin-bottom: 10px; flex-shrink: 0; }

    .header h1 {
      color: #fff; font-size: 30px; font-weight: 800; text-transform: uppercase;
      text-shadow: 0 0 5px #fff, 0 0 20px #ff00de; margin-bottom: 5px;
      letter-spacing: 1px;
    }

    .slogan {
      font-size: 14px; font-weight: 600; background: rgba(0, 0, 0, 0.7);
      display: inline-block; padding: 5px 15px; border-radius: 50px;
      border: 1px solid #00ffea; color: #00ffea;
    }

    .main-content {
      flex: 1; display: flex; flex-direction: column;
      max-width: 900px; width: 100%; margin: 0 auto; min-height: 0;
    }

    .text-display-wrapper {
      flex: 1; background: rgba(255, 255, 255, 0.95);
      border-radius: 16px; 
      overflow: hidden; 
      margin-bottom: 15px; position: relative;
      border: 2px solid rgba(255,255,255,0.2);
      display: flex; flex-direction: column;
    }

    .text-display {
      flex: 1; position: relative; padding: 0 40px; overflow-y: hidden; display: block; 
    }

    .text-display.review-mode {
      overflow-y: auto; padding-top: 20px; padding-bottom: 20px;
    }

    #content-wrapper {
      width: 100%; text-align: justify;
      position: absolute; top: 100%; left: 0; right: 0;
      padding-bottom: 100px;
    }

    .review-mode #content-wrapper {
      position: relative; top: 0 !important; transform: none !important; animation: none !important;
    }

    .scrolling { animation: scrollUp 60s linear forwards; }
    @keyframes scrollUp { 
      from { top: 100%; transform: translateY(0); } 
      to { top: 0; transform: translateY(-100%); } 
    }

    .word {
      display: inline-block; font-size: 24px; line-height: 1.8;
      padding: 0 2px; border-radius: 4px; color: #333; margin-right: 4px;
    }
    .word.correct { background-color: #48bb78; color: #fff; border-bottom: 2px solid #2f855a; }
    .word.wrong { color: #e53e3e; text-decoration: line-through; opacity: 0.5; }

    .controls {
      display: flex; gap: 15px; align-items: center; justify-content: center;
      background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 16px; flex-shrink: 0;
    }

    .btn {
      padding: 12px 24px; font-size: 16px; font-weight: bold; border: none; border-radius: 50px;
      cursor: pointer; transition: 0.2s; min-width: 130px;
    }
    .btn-main { background: #fbbf24; color: #744210; }
    .btn-main:hover { background: #fff; }
    .btn-next { background: #63b3ed; color: #fff; }
    
    .timer { font-size: 24px; font-weight: 700; color: #fff; min-width: 70px; text-align: center; }

    .result-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 2000; display: none;
      align-items: center; justify-content: center;
    }
    .result-modal.active { display: flex; }
    .result-box {
      background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 450px;
      border: 4px solid #ccc;
    }
    .result-score { font-size: 60px; font-weight: 900; margin: 15px 0; }
    .result-msg { font-size: 22px; font-weight: 600; line-height: 1.4; margin-bottom: 20px; color: #333; }
    
    .french-mode .result-box { border-color: #48bb78; box-shadow: 0 0 30px #48bb78; }
    .french-mode .result-score { color: #48bb78; }
    .french-mode .result-msg { color: #2f855a; }
    
    .chicken-mode .result-box { border-color: #ff4757; box-shadow: 0 0 30px #ff4757; }
    .chicken-mode .result-score { color: #ff4757; }
    .chicken-mode .result-msg { color: #c53030; }

    .btn-close { background: #333; color: white; padding: 10px 25px; border-radius: 50px; border: none; cursor: pointer; margin-top: 15px; }
    
    .topic-badge {
      position: absolute; top: 10px; left: 10px; 
      background: #333; color: #fff; padding: 4px 10px; 
      border-radius: 4px; font-size: 12px; z-index: 10;
      text-transform: uppercase; letter-spacing: 1px;
    }
    #debugInfo {
        position: fixed; bottom: 5px; left: 5px; 
        font-size: 10px; color: rgba(255,255,255,0.8); 
        max-width: 300px; z-index: 2001; pointer-events: none;
        background: rgba(0,0,0,0.5); padding: 5px; border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="overlay"></div>
  
  <div class="app-container">
    <header class="header">
      <h1>CHECK PRONONCIATION AVEC ANN</h1>
      <div class="slogan">ü§µ B·∫°n l√† ng∆∞·ªùi Ph√°p hay l√† con g√† e? üêî</div>
    </header>

    <main class="main-content">
      <div class="text-display-wrapper">
        <div class="topic-badge" id="topicDisplay">Topic</div>
        <div class="timer" id="timer" style="position: absolute; top: 10px; right: 10px; color: #333; z-index: 10;">01:00</div>
        
        <div class="text-display" id="textDisplayArea">
          <div id="content-wrapper"></div>
        </div>
      </div>

      <div class="controls">
        <button id="mainBtn" class="btn btn-main">D√©marrer (B·∫Øt ƒë·∫ßu)</button>
        <button id="nextBtn" class="btn btn-next">B√†i kh√°c (Autres) ></button>
      </div>
    </main>
  </div>
  
  <div id="debugInfo">Waiting...</div>

  <div class="result-modal" id="resultModal">
    <div class="result-box">
      <h2>K·∫æT QU·∫¢</h2>
      <div class="result-score" id="modalScore">0%</div>
      <div class="result-msg" id="modalMsg">...</div>
      <button class="btn-close" onclick="closeResult()">Xem l·∫°i l·ªói sai</button>
    </div>
  </div>

  <script>
    const readingLibrary = [
      { topic: "Kh√°m ph√° Paris", text: "Paris est souvent appel√©e la ville lumi√®re, et pour cause. Quand le soleil se couche, les monuments s'illuminent et cr√©ent une atmosph√®re magique et romantique. Se promener sur les quais de la Seine est une exp√©rience inoubliable pour les touristes du monde entier. On peut admirer la cath√©drale Notre-Dame, le mus√©e du Louvre et bien s√ªr, la majestueuse tour Eiffel qui brille dans la nuit. Mais Paris, ce n'est pas seulement des monuments. C'est aussi l'odeur du caf√© frais le matin, les boulangeries qui vendent des croissants chauds et les artistes qui peignent dans les rues de Montmartre. C'est une ville qui vit, qui respire et qui inspire les po√®tes depuis des si√®cles." },
      { topic: "Ngh·ªá thu·∫≠t s·ªëng", text: "En France, la gastronomie est bien plus qu'une simple fa√ßon de se nourrir, c'est un v√©ritable art de vivre. Le repas est un moment sacr√© o√π la famille et les amis se r√©unissent pour partager du bonheur et des discussions anim√©es. On prend le temps de d√©guster chaque plat, de l'entr√©e au dessert, accompagn√© souvent d'un verre de vin rouge ou blanc. Les march√©s locaux regorgent de produits frais : des fromages vari√©s, des l√©gumes color√©s et des fruits d√©licieux. Cuisiner est un acte d'amour et de tradition. Chaque r√©gion poss√®de ses propres sp√©cialit√©s et ses secrets culinaires qui se transmettent de g√©n√©ration en g√©n√©ration avec fiert√©." },
      { topic: "L·ª£i √≠ch c·ªßa vi·ªác ƒë·ªçc s√°ch", text: "Dans notre monde moderne domin√© par les √©crans et la technologie, prendre le temps de lire un livre est devenu un luxe pr√©cieux. La lecture nous permet de voyager sans bouger de notre fauteuil. Elle ouvre notre esprit √† de nouvelles id√©es, enrichit notre vocabulaire et stimule notre imagination. Quand on lit un roman, on vit mille vies diff√©rentes, on ressent les √©motions des personnages et on oublie nos propres soucis quotidiens. Que ce soit de la po√©sie, de la science-fiction ou de l'histoire, chaque livre est une porte ouverte vers un autre univers. C'est une habitude qui calme l'esprit et nourrit l'√¢me en profondeur." }
    ];

    // ===== STATE MANAGEMENT =====
    let currentIdx = 0;
    let mediaRecorder = null;
    let fullTranscript = "";
    
    let timerInterval = null;
    let chunkInterval = null;
    let resultTimeout = null;
    
    const TIME_LIMIT = 60;
    let timeLeft = TIME_LIMIT;
    let streamReference = null;
    let currentSessionId = 0;
    
    // DOM
    const contentWrapper = document.getElementById('content-wrapper');
    const textDisplayArea = document.getElementById('textDisplayArea');
    const mainBtn = document.getElementById('mainBtn');
    const nextBtn = document.getElementById('nextBtn');
    const timerDisplay = document.getElementById('timer');
    const topicDisplay = document.getElementById('topicDisplay');
    const resultModal = document.getElementById('resultModal');
    const modalScore = document.getElementById('modalScore');
    const modalMsg = document.getElementById('modalMsg');
    const debugInfo = document.getElementById('debugInfo');

    // ===== CORE RESET FUNCTION =====
    function nuclearReset() {
       console.log('üîÑ NUCLEAR RESET INITIATED');
       
       // 1. Stop all timers immediately
       if (timerInterval) {
         clearInterval(timerInterval);
         timerInterval = null;
       }
       if (chunkInterval) {
         clearInterval(chunkInterval);
         chunkInterval = null;
       }
       if (resultTimeout) {
         clearTimeout(resultTimeout);
         resultTimeout = null;
       }
       
       // 2. Increase session ID to invalidate old callbacks
       currentSessionId++;
       console.log(`‚úÖ New Session ID: ${currentSessionId}`);
       
       // 3. Clear transcript
       fullTranscript = "";
       debugInfo.textContent = "Ready...";
       
       // 4. Stop microphone
       if(mediaRecorder && mediaRecorder.state !== 'inactive') {
         try { 
           mediaRecorder.stop(); 
           console.log('üé§ Microphone stopped');
         } catch(e){
           console.warn('‚ö†Ô∏è MediaRecorder already stopped');
         }
       }
       mediaRecorder = null;
       
       if(streamReference) {
         try { 
           streamReference.getTracks().forEach(track => track.stop()); 
           console.log('üîá Stream tracks stopped');
         } catch(e){
           console.warn('‚ö†Ô∏è Stream already stopped');
         }
         streamReference = null;
       }
       
       // 5. Reset UI
       mainBtn.disabled = false;
       mainBtn.textContent = "D√©marrer (B·∫Øt ƒë·∫ßu)";
       mainBtn.classList.remove('btn-retry');
       mainBtn.classList.add('btn-main');
       contentWrapper.classList.remove('scrolling');
       
       // 6. CRITICAL: Reset timer display immediately
       timeLeft = TIME_LIMIT;
       timerDisplay.textContent = "01:00";
       
       console.log('‚úÖ Reset complete');
    }

    function loadText(index) {
      nuclearReset(); 
      
      const data = readingLibrary[index];
      topicDisplay.textContent = data.topic;
      const words = data.text.trim().split(/\s+/);
      contentWrapper.innerHTML = '';
      words.forEach(word => {
        const span = document.createElement('span');
        span.className = 'word';
        span.textContent = word;
        span.dataset.clean = normalizeWord(word); 
        contentWrapper.appendChild(span);
      });
      
      textDisplayArea.className = 'text-display';
      contentWrapper.className = '';
      
      console.log(`üìÑ Loaded: ${data.topic} (${words.length} words)`);
    }

    function normalizeWord(word) {
      return word.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "").replace(/\s+/g, "");
    }

    // ===== EVENT HANDLERS =====
    mainBtn.addEventListener('click', async () => {
      if (mainBtn.classList.contains('btn-retry')) {
        loadText(currentIdx);
        return; 
      }
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        streamReference = stream;
        startSession(stream);
      } catch (err) {
        alert("L·ªói Micro: " + err.message);
      }
    });

    nextBtn.addEventListener('click', () => {
      randomizeLesson();
    });

    function randomizeLesson() {
      let newIdx;
      do { 
        newIdx = Math.floor(Math.random() * readingLibrary.length); 
      } while (newIdx === currentIdx && readingLibrary.length > 1);
      currentIdx = newIdx;
      loadText(currentIdx);
    }

    function startSession(stream) {
      console.log('üé¨ Starting new session...');
      
      // Ensure clean state
      if (timerInterval) clearInterval(timerInterval);
      if (chunkInterval) clearInterval(chunkInterval);
      
      const sessionForThisRecorder = currentSessionId;
      console.log(`üéØ Session ID: ${sessionForThisRecorder}`);
      
      // Reset time BEFORE starting
      timeLeft = TIME_LIMIT; 
      timerDisplay.textContent = "01:00";
      
      mainBtn.disabled = true;
      mainBtn.textContent = "ƒêang nghe...";
      contentWrapper.classList.add('scrolling');
      
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) {
          sendToIBM(e.data, sessionForThisRecorder);
        }
      };

      mediaRecorder.start();
      console.log('üé§ Recording started');

      // Chunk every 4 seconds
      chunkInterval = setInterval(() => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            if (timeLeft > 0 && currentSessionId === sessionForThisRecorder) {
                mediaRecorder.start();
            }
        }
      }, 4000);

      // Timer countdown
      timerInterval = setInterval(() => {
        // Only run if this is still the current session
        if (currentSessionId !== sessionForThisRecorder) {
          console.log('‚èπÔ∏è Old timer detected, stopping...');
          clearInterval(timerInterval);
          return;
        }
        
        timeLeft--;
        
        const displayTime = Math.max(0, timeLeft);
        timerDisplay.textContent = `00:${displayTime < 10 ? '0'+displayTime : displayTime}`;
        
        console.log(`‚è±Ô∏è Time: ${displayTime}s (Session ${sessionForThisRecorder})`);
        
        if (timeLeft <= 0) {
            console.log('‚è∞ Time\'s up!');
            clearInterval(timerInterval);
            timerInterval = null;
            finishSession();
        }
      }, 1000);
    }

    async function sendToIBM(blob, sessionId) {
      // Validate session
      if (sessionId !== currentSessionId) {
        console.log(`‚ùå Rejected old session data (${sessionId} vs ${currentSessionId})`);
        return;
      }
      
      if (blob.size < 1000) return;

      const formData = new FormData();
      formData.append('audio', blob, 'chunk.webm');
      
      try {
        const res = await fetch('/api/transcribe', { method: 'POST', body: formData });
        const data = await res.json();
        
        // Double-check session after async operation
        if (sessionId !== currentSessionId) {
          console.log(`‚ùå Session changed during transcription`);
          return;
        }

        if (data.text) {
            fullTranscript += " " + data.text;
            debugInfo.textContent = `üìù Session ${sessionId}: ${fullTranscript.substring(Math.max(0, fullTranscript.length - 80))}`;
            console.log(`‚úÖ Transcript: "${data.text}"`);
        }
      } catch (e) { 
        console.error('‚ùå IBM Error:', e); 
      }
    }

    function finishSession() {
      console.log('üèÅ Finishing session...');
      
      if (timerInterval) clearInterval(timerInterval);
      if (chunkInterval) clearInterval(chunkInterval);
      
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
      if (streamReference) {
        streamReference.getTracks().forEach(track => track.stop());
      }
      
      mainBtn.textContent = "ƒêang ch·∫•m ƒëi·ªÉm...";
      
      // Wait 3s for final transcription
      resultTimeout = setTimeout(() => {
          if(mainBtn.textContent === "ƒêang ch·∫•m ƒëi·ªÉm...") {
              calculateResult();
          }
      }, 3000); 
    }

    function calculateResult() {
      console.log('üìä Calculating results...');
      console.log('Full transcript:', fullTranscript);
      
      const spokenWordsArray = fullTranscript.toLowerCase().split(/\s+/).map(w => normalizeWord(w));
      const domWords = document.querySelectorAll('.word');
      let correctCount = 0;

      domWords.forEach(span => {
        const targetWord = span.dataset.clean;
        const foundIndex = spokenWordsArray.indexOf(targetWord);

        if (foundIndex !== -1) {
          span.classList.add('correct');
          correctCount++;
          spokenWordsArray.splice(foundIndex, 1);
        } else {
          span.classList.add('wrong');
        }
      });

      const score = Math.round((correctCount / domWords.length) * 100) || 0;
      
      console.log(`‚úÖ Score: ${score}% (${correctCount}/${domWords.length})`);

      resultModal.className = 'result-modal active';
      resultModal.classList.remove('french-mode', 'chicken-mode');
      
      if (score >= 50) {
        resultModal.classList.add('french-mode');
        modalMsg.innerHTML = "Ch√∫c m·ª´ng, b·∫°n l√† ng∆∞·ªùi Ph√°p üá´üá∑üç∑";
      } else {
        resultModal.classList.add('chicken-mode');
        modalMsg.innerHTML = "L√™u l√™u, b·∫°n l√† con g√† e üêîü§£";
      }
      modalScore.textContent = `${score}%`;

      mainBtn.disabled = false;
      mainBtn.textContent = "üîÑ L√†m l·∫°i";
      mainBtn.classList.add('btn-retry');
      mainBtn.classList.remove('btn-main');
    }

    function closeResult() {
      resultModal.style.display = 'none';
      textDisplayArea.classList.add('review-mode');
    }

    window.onload = function() { 
      randomizeLesson(); 
      console.log('‚úÖ App loaded');
    };
  </script>
</body>
</html>
