<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luy·ªán Ph√°t √Çm (Avec Ann)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body { height: 100%; width: 100%; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      /* Nh·ªõ ƒë·∫£m b·∫£o b·∫°n ƒë√£ upload file bg.jpg l√™n Github/Vercel */
      background: url('bg.jpg') no-repeat center center fixed; 
      background-size: cover;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      color: #fff;
    }

    /* L·ªõp ph·ªß t·ªëi */
    .overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); z-index: 0;
    }

    .app-container {
      width: 100%; height: 100%; display: flex; flex-direction: column;
      padding: 24px; position: relative; z-index: 1;
    }

    .header { text-align: center; margin-bottom: 10px; }

    /* Ch·ªØ Neon */
    .header h1 {
      color: #fff; font-size: 40px; font-weight: 800; text-transform: uppercase;
      text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #ff00de, 0 0 40px #ff00de;
      margin-bottom: 10px;
    }

    .slogan {
      font-size: 16px; font-weight: 600; background: rgba(0, 0, 0, 0.7);
      display: inline-block; padding: 8px 20px; border-radius: 50px;
      border: 1px solid #00ffea; box-shadow: 0 0 10px #00ffea; color: #00ffea;
    }

    .main-content {
      flex: 1; display: flex; flex-direction: column;
      max-width: 800px; width: 100%; margin: 0 auto; min-height: 0;
    }

    /* Khu v·ª±c hi·ªÉn th·ªã vƒÉn b·∫£n */
    .text-display-wrapper {
      flex: 1; background: rgba(255, 255, 255, 0.95);
      border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      overflow: hidden; margin-bottom: 20px; position: relative;
      border: 2px solid rgba(255,255,255,0.2);
    }

    .text-display {
      height: 100%; overflow: hidden; position: relative;
      padding: 30px; display: flex; align-items: flex-start; justify-content: center;
    }

    /* Container ch·ª©a ch·ªØ (ƒë·ªÉ tr√¥i l√™n) */
    #content-wrapper {
      width: 100%; text-align: justify;
      position: absolute; top: 0; left: 30px; right: 30px;
      padding-top: 150px; /* ƒê·ªÉ ch·ªØ b·∫Øt ƒë·∫ßu t·ª´ gi·ªØa */
      transition: transform 0.5s ease;
    }

    /* Animation tr√¥i ch·ªØ 60s */
    .scrolling { animation: scrollUp 60s linear forwards; }
    @keyframes scrollUp { from { transform: translateY(0); } to { transform: translateY(-100%); } }

    .word {
      display: inline-block; font-size: 26px; line-height: 1.8;
      padding: 2px 4px; border-radius: 4px; color: #333; margin-right: 5px;
      transition: all 0.3s;
    }
    
    /* M√†u s·∫Øc k·∫øt qu·∫£ */
    .word.correct { background-color: #48bb78; color: #fff; font-weight: bold; border-bottom: 2px solid #2f855a; }
    .word.wrong { background-color: #fed7d7; color: #c53030; opacity: 0.6; text-decoration: line-through; }

    /* Controls */
    .controls {
      display: flex; gap: 15px; align-items: center; justify-content: center;
      background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.2); margin-bottom: 10px;
    }

    .btn {
      padding: 14px 28px; font-size: 16px; font-weight: bold; border: none; border-radius: 50px;
      cursor: pointer; transition: 0.2s; min-width: 140px;
    }
    .btn-main { background: #fbbf24; color: #744210; box-shadow: 0 0 15px #fbbf24; }
    .btn-main:hover { transform: scale(1.05); background: #fff; }
    .btn-retry { background: #48bb78 !important; color: white !important; box-shadow: 0 0 15px #48bb78; }
    
    .timer { font-size: 28px; font-weight: 700; color: #fff; min-width: 80px; text-align: center; text-shadow: 0 0 10px cyan; }

    /* POPUP K·∫æT QU·∫¢ */
    .result-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 2000; display: none;
      align-items: center; justify-content: center; backdrop-filter: blur(5px);
    }
    .result-modal.active { display: flex; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .result-box {
      background: #fff; color: #333; padding: 40px; border-radius: 25px;
      text-align: center; max-width: 500px; width: 90%;
      border: 5px solid #ccc; box-shadow: 0 0 50px rgba(255,255,255,0.2);
    }
    .result-score { font-size: 60px; font-weight: 900; margin: 10px 0; }
    .result-msg { font-size: 22px; font-weight: 600; line-height: 1.5; margin-bottom: 30px; }
    
    /* Style ri√™ng cho G√† v√† Ph√°p */
    .french-mode .result-box { border-color: #48bb78; box-shadow: 0 0 60px #48bb78; }
    .french-mode .result-score { color: #48bb78; }
    
    .chicken-mode .result-box { border-color: #ff4757; box-shadow: 0 0 60px #ff4757; }
    .chicken-mode .result-score { color: #ff4757; }

    .btn-close { background: #333; color: white; padding: 12px 30px; border-radius: 50px; font-size: 16px; cursor: pointer; border: none; }
  </style>
</head>
<body>
  <div class="overlay"></div>
  
  <div class="app-container">
    <header class="header">
      <h1>üá´üá∑ Avec Ann üá´üá∑</h1>
      <div class="slogan">ü§µ B·∫°n l√† ng∆∞·ªùi Ph√°p hay l√† con g√†e? üêî</div>
    </header>

    <main class="main-content">
      <div class="text-display-wrapper">
        <div class="text-display">
          <div class="timer" id="timer" style="position: absolute; top: 10px; right: 10px; color: #333; text-shadow: none;">01:00</div>
          <div id="content-wrapper"></div>
        </div>
      </div>

      <div class="controls">
        <button id="mainBtn" class="btn btn-main">D√©marrer (B·∫Øt ƒë·∫ßu)</button>
        <button id="nextBtn" class="btn" style="background: #e2e8f0;">B√†i kh√°c ></button>
      </div>
    </main>
  </div>

  <div class="result-modal" id="resultModal">
    <div class="result-box">
      <h2 style="margin-bottom: 10px;">K·∫æT QU·∫¢</h2>
      <div class="result-score" id="modalScore">0%</div>
      <div class="result-msg" id="modalMsg">...</div>
      <p id="wordCountMsg" style="color: #666; margin-bottom: 20px;">...</p>
      <button class="btn-close" onclick="closeResult()">Xem l·∫°i l·ªói sai</button>
    </div>
  </div>

  <script>
    // --- 1. N·ªòI DUNG B√ÄI ƒê·ªåC D√ÄI (ƒê√öNG NH∆Ø B·∫†N Y√äU C·∫¶U) ---
    const frenchText = `
      Apprendre une nouvelle langue est comme ouvrir une fen√™tre sur un monde inconnu. 
      C‚Äôest une aventure passionnante qui demande du courage et de la patience. 
      Quand on parle fran√ßais, on d√©couvre la culture de la France, la beaut√© de Paris 
      et l‚Äôhistoire des grands √©crivains comme Victor Hugo. 
      
      Chaque jour est une opportunit√© pour progresser. 
      Il ne faut pas avoir peur de faire des erreurs, car c‚Äôest en tombant qu‚Äôon apprend √† marcher. 
      √âcoutez de la musique, regardez des films et parlez avec des amis. 
      La prononciation peut √™tre difficile au d√©but, mais avec de la pratique, 
      votre voix deviendra naturelle et fluide. 
      
      Le voyage est plus important que la destination. 
      Alors, respirez profond√©ment, souriez et commencez √† lire ce texte avec confiance. 
      Votre effort aujourd'hui sera votre succ√®s de demain. 
      Bonne chance et amusez-vous bien !
    `;

    // --- 2. BI·∫æN H·ªÜ TH·ªêNG ---
    let mediaRecorder;
    let fullTranscript = ""; 
    let timerInterval, recordingInterval;
    const TIME_LIMIT = 60;
    let timeLeft = TIME_LIMIT;
    let isFinished = false;

    // DOM Elements
    const contentWrapper = document.getElementById('content-wrapper');
    const mainBtn = document.getElementById('mainBtn');
    const timerDisplay = document.getElementById('timer');
    const resultModal = document.getElementById('resultModal');
    const modalScore = document.getElementById('modalScore');
    const modalMsg = document.getElementById('modalMsg');

    // --- 3. KH·ªûI T·∫†O B√ÄI ƒê·ªåC ---
    function initText() {
      const words = frenchText.trim().split(/\s+/);
      contentWrapper.innerHTML = '';
      words.forEach(word => {
        const span = document.createElement('span');
        span.className = 'word';
        span.textContent = word;
        span.dataset.clean = normalizeWord(word); 
        contentWrapper.appendChild(span);
      });
    }

    function normalizeWord(word) {
      return word.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "").replace(/\s+/g, "");
    }

    // --- 4. X·ª¨ L√ù N√öT B·∫§M ---
    mainBtn.addEventListener('click', async () => {
      if (isFinished) {
        location.reload(); // Reset game
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        startSession(stream);
      } catch (err) {
        alert("L·ªói Micro: " + err.message);
      }
    });

    // --- 5. B·∫ÆT ƒê·∫¶U GHI √ÇM (LOGIC FREE STYLE) ---
    function startSession(stream) {
      mainBtn.disabled = true;
      mainBtn.textContent = "ƒêang nghe...";
      contentWrapper.classList.add('scrolling'); // B·∫Øt ƒë·∫ßu tr√¥i ch·ªØ

      fullTranscript = "";
      
      // Setup Ghi √¢m & Chunking (G·ª≠i 3s/l·∫ßn)
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) sendToIBM(e.data);
      };

      mediaRecorder.start();
      recordingInterval = setInterval(() => {
        if(mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          mediaRecorder.start();
        }
      }, 3000);

      // ƒê·∫øm ng∆∞·ª£c
      timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
        if (timeLeft <= 0) finishSession();
      }, 1000);
    }

    // --- 6. G·ª¨I AUDIO L√äN IBM ---
    async function sendToIBM(blob) {
      const formData = new FormData();
      formData.append('audio', blob, 'chunk.webm');
      try {
        // G·ª≠i l√™n API Backend (B·∫°n ƒë√£ c·∫•u h√¨nh trong api/transcribe.js)
        const res = await fetch('/api/transcribe', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.text) {
          fullTranscript += " " + data.text;
          console.log("Nghe ƒë∆∞·ª£c:", fullTranscript);
        }
      } catch (e) { console.error(e); }
    }

    // --- 7. K·∫æT TH√öC & CH·∫§M ƒêI·ªÇM ---
    function finishSession() {
      clearInterval(timerInterval);
      clearInterval(recordingInterval);
      if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
      
      mainBtn.textContent = "ƒêang ch·∫•m ƒëi·ªÉm...";
      
      // D·ª´ng ch·ªØ tr√¥i v√† reset v·ªÅ ƒë·∫ßu trang ƒë·ªÉ xem k·∫øt qu·∫£
      contentWrapper.classList.remove('scrolling');
      contentWrapper.style.transform = 'translateY(0)';
      contentWrapper.style.paddingTop = '50px';

      // Ch·ªù 2s ƒë·ªÉ API tr·∫£ n·ªët k·∫øt qu·∫£ cu·ªëi
      setTimeout(calculateResult, 2000);
    }

    function calculateResult() {
      isFinished = true;
      const allSpokenWords = fullTranscript.toLowerCase();
      const domWords = document.querySelectorAll('.word');
      let correctCount = 0;

      domWords.forEach(span => {
        const original = span.dataset.clean;
        // Logic Bag-of-Words: Ch·ªâ c·∫ßn c√≥ t·ª´ ƒë√≥ trong ƒëo·∫°n ghi √¢m l√† t√≠nh ƒë√∫ng
        if (original && allSpokenWords.includes(original)) {
          span.classList.add('correct');
          correctCount++;
        } else {
          span.classList.add('wrong');
        }
      });

      // T√≠nh ƒëi·ªÉm
      const score = Math.round((correctCount / domWords.length) * 100);

      // X·ª≠ l√Ω G√† vs Ph√°p
      resultModal.className = 'result-modal active'; // Reset class
      if (score >= 50) {
        resultModal.classList.add('french-mode');
        modalMsg.innerHTML = "Ch√∫c m·ª´ng!<br>B·∫°n l√† ng∆∞·ªùi Ph√°p üá´üá∑üç∑";
      } else {
        resultModal.classList.add('chicken-mode');
        modalMsg.innerHTML = "Chia bu·ªìn!<br>B·∫°n l√† con g√†e üêîü§£";
      }

      modalScore.textContent = `${score}%`;
      document.getElementById('wordCountMsg').textContent = `ƒê·ªçc ƒë√∫ng: ${correctCount}/${domWords.length} t·ª´`;

      // ƒê·ªïi n√∫t th√†nh n√∫t Reset
      mainBtn.disabled = false;
      mainBtn.textContent = "üîÑ L√†m l·∫°i b√†i n√†y";
      mainBtn.classList.add('btn-retry');
    }

    function closeResult() {
      resultModal.style.display = 'none';
      // Ng∆∞·ªùi d√πng s·∫Ω th·∫•y vƒÉn b·∫£n ƒë√£ ƒë∆∞·ª£c t√¥ m√†u
    }
    
    document.getElementById('nextBtn').addEventListener('click', () => {
        alert("T√≠nh nƒÉng ch·ªçn b√†i s·∫Ω s·ªõm ra m·∫Øt!");
    });

    // Ch·∫°y khi load
    initText();
  </script>
</body>
</html>
