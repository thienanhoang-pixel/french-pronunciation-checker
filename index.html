<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corriger La Prononciation Avec Ann</title>
  <link rel="icon" href="favicon.png" type="image/png">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; width: 100%; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('bg.jpg') no-repeat center center fixed; 
      background-size: cover;
      display: flex; flex-direction: column; overflow: hidden; color: #fff;
    }
    .overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); z-index: 0;
    }
    .app-container {
      width: 100%; height: 100%; display: flex; flex-direction: column;
      padding: 24px; position: relative; z-index: 1;
    }
    .header { text-align: center; margin-bottom: 10px; flex-shrink: 0; }
    .header h1 {
      color: #fff; font-size: 36px; font-weight: 800; text-transform: uppercase;
      text-shadow: 0 0 10px #fff, 0 0 20px #00ffea, 0 0 30px #00ffea, 0 0 40px #00ffea;
      margin-bottom: 5px; letter-spacing: 2px;
      animation: neonPulse 2s ease-in-out infinite;
    }
    @keyframes neonPulse {
      0%, 100% { text-shadow: 0 0 10px #fff, 0 0 20px #00ffea, 0 0 30px #00ffea; }
      50% { text-shadow: 0 0 20px #fff, 0 0 30px #00ffea, 0 0 40px #00ffea, 0 0 50px #00ffea; }
    }
    .slogan {
      font-size: 14px; font-weight: 600; background: rgba(0, 0, 0, 0.7);
      display: inline-block; padding: 5px 15px; border-radius: 50px;
      border: 1px solid #00ffea; color: #00ffea;
    }
    .main-content {
      flex: 1; display: flex; flex-direction: column;
      max-width: 900px; width: 100%; margin: 0 auto; min-height: 0;
    }
    .text-display-wrapper {
      flex: 1; background: rgba(255, 255, 255, 0.95);
      border-radius: 16px; overflow: hidden; margin-bottom: 15px; position: relative;
      border: 2px solid rgba(255,255,255,0.2); display: flex; flex-direction: column;
    }
    .text-display {
      flex: 1; position: relative; padding: 0 40px; overflow-y: hidden; display: block; 
    }
    .text-display.review-mode {
      overflow-y: auto; padding-top: 20px; padding-bottom: 20px;
    }
    #content-wrapper {
      width: 100%; text-align: justify;
      position: absolute; top: 100%; left: 0; right: 0; padding-bottom: 100px;
    }
    .review-mode #content-wrapper {
      position: relative; top: 0 !important; transform: none !important; animation: none !important;
    }
    .scrolling { animation: scrollUp 60s linear forwards; }
    @keyframes scrollUp { 
      from { top: 100%; transform: translateY(0); } 
      to { top: 0; transform: translateY(-100%); } 
    }
    .word {
      display: inline-block; font-size: 24px; line-height: 1.8;
      padding: 0 2px; border-radius: 4px; color: #333; margin-right: 4px;
    }
    .word.correct { background-color: #48bb78; color: #fff; }
    .word.wrong { color: #e53e3e; text-decoration: line-through; opacity: 0.6; }
    .controls {
      display: flex; gap: 15px; align-items: center; justify-content: center;
      background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 16px; flex-shrink: 0;
    }
    .btn {
      padding: 12px 24px; font-size: 16px; font-weight: bold; border: none; border-radius: 50px;
      cursor: pointer; transition: 0.2s; min-width: 130px;
    }
    .btn-main { background: #fbbf24; color: #744210; }
    .btn-main:hover { background: #fff; }
    .btn-next { background: #63b3ed; color: #fff; }
    .timer { font-size: 24px; font-weight: 700; color: #fff; min-width: 70px; text-align: center; }
    .result-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 2000; display: none;
      align-items: center; justify-content: center;
    }
    .result-modal.active { display: flex; }
    .result-box {
      background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 450px;
      border: 4px solid #ccc;
    }
    .result-score { font-size: 50px; font-weight: 900; margin: 15px 0; }
    .french-mode .result-score { color: #48bb78; }
    .chicken-mode .result-score { color: #ff4757; }
    .btn-close { background: #333; color: white; padding: 10px 25px; border-radius: 50px; border: none; cursor: pointer; margin-top: 15px; }
    .topic-badge {
      position: absolute; top: 10px; left: 10px; 
      background: #333; color: #fff; padding: 4px 10px; 
      border-radius: 4px; font-size: 12px; z-index: 10;
      text-transform: uppercase; letter-spacing: 1px;
    }
    .debug-info {
      position: absolute; bottom: 10px; left: 10px; right: 10px;
      background: rgba(0,0,0,0.8); color: #0f0; padding: 8px;
      border-radius: 8px; font-size: 11px; font-family: monospace;
      max-height: 80px; overflow-y: auto; z-index: 10;
    }
  </style>
</head>
<body>
  <div class="overlay"></div>
  
  <div class="app-container">
    <header class="header">
      <h1>üá´üá∑ Corriger La Prononciation Avec Ann üá´üá∑</h1>
      <div class="slogan">ü§µ B·∫°n l√† ng∆∞·ªùi Ph√°p hay l√† con g√† e? üêî</div>
    </header>

    <main class="main-content">
      <div class="text-display-wrapper">
        <div class="topic-badge" id="topicDisplay">Topic</div>
        <div class="timer" id="timer" style="position: absolute; top: 10px; right: 10px; color: #333; z-index: 10;">01:00</div>
        
        <div class="text-display" id="textDisplayArea">
          <div id="content-wrapper"></div>
        </div>
        
        <div class="debug-info" id="debugInfo" style="display: none;">
          üé§ ƒêang nghe...
        </div>
      </div>

      <div class="controls">
        <button id="mainBtn" class="btn btn-main">D√©marrer (B·∫Øt ƒë·∫ßu)</button>
        <button id="nextBtn" class="btn btn-next">B√†i kh√°c (Autres) ></button>
      </div>
    </main>
  </div>

  <div class="result-modal" id="resultModal">
    <div class="result-box">
      <h2>K·∫æT QU·∫¢</h2>
      <div class="result-score" id="modalScore">0%</div>
      <div class="result-msg" id="modalMsg">...</div>
      <button class="btn-close" onclick="closeResult()">Xem l·∫°i l·ªói sai</button>
    </div>
  </div>

  <script>
    const readingLibrary = [
      {
        topic: "Kh√°m ph√° Paris",
        text: "Paris est souvent appel√©e la ville lumi√®re, et pour cause. Quand le soleil se couche, les monuments s'illuminent et cr√©ent une atmosph√®re magique et romantique. Se promener sur les quais de la Seine est une exp√©rience inoubliable pour les touristes du monde entier. On peut admirer la cath√©drale Notre-Dame, le mus√©e du Louvre et bien s√ªr, la majestueuse tour Eiffel qui brille dans la nuit. Mais Paris, ce n'est pas seulement des monuments. C'est aussi l'odeur du caf√© frais le matin, les boulangeries qui vendent des croissants chauds et les artistes qui peignent dans les rues de Montmartre. C'est une ville qui vit, qui respire et qui inspire les po√®tes depuis des si√®cles."
      },
      {
        topic: "Ngh·ªá thu·∫≠t s·ªëng",
        text: "En France, la gastronomie est bien plus qu'une simple fa√ßon de se nourrir, c'est un v√©ritable art de vivre. Le repas est un moment sacr√© o√π la famille et les amis se r√©unissent pour partager du bonheur et des discussions anim√©es. On prend le temps de d√©guster chaque plat, de l'entr√©e au dessert, accompagn√© souvent d'un verre de vin rouge ou blanc. Les march√©s locaux regorgent de produits frais : des fromages vari√©s, des l√©gumes color√©s et des fruits d√©licieux. Cuisiner est un acte d'amour et de tradition. Chaque r√©gion poss√®de ses propres sp√©cialit√©s et ses secrets culinaires qui se transmettent de g√©n√©ration en g√©n√©ration avec fiert√©."
      },
      {
        topic: "L·ª£i √≠ch c·ªßa vi·ªác ƒë·ªçc s√°ch",
        text: "Dans notre monde moderne domin√© par les √©crans et la technologie, prendre le temps de lire un livre est devenu un luxe pr√©cieux. La lecture nous permet de voyager sans bouger de notre fauteuil. Elle ouvre notre esprit √† de nouvelles id√©es, enrichit notre vocabulaire et stimule notre imagination. Quand on lit un roman, on vit mille vies diff√©rentes, on ressent les √©motions des personnages et on oublie nos propres soucis quotidiens. Que ce soit de la po√©sie, de la science-fiction ou de l'histoire, chaque livre est une porte ouverte vers un autre univers. C'est une habitude qui calme l'esprit et nourrit l'√¢me en profondeur."
      },
      {
        topic: "B·∫£o v·ªá thi√™n nhi√™n",
        text: "La nature nous offre tout ce dont nous avons besoin pour vivre : l'air que nous respirons, l'eau que nous buvons et la nourriture que nous mangeons. Cependant, l'activit√© humaine menace aujourd'hui cet √©quilibre fragile. Les for√™ts disparaissent, les oc√©ans sont pollu√©s et le climat change rapidement. Il est urgent de changer nos habitudes pour prot√©ger notre belle plan√®te bleue. Des gestes simples peuvent faire une grande diff√©rence, comme r√©duire notre consommation de plastique, recycler nos d√©chets ou utiliser les transports en commun. Prot√©ger l'environnement, ce n'est pas seulement sauver les animaux, c'est aussi assurer un avenir sain et heureux pour nos enfants et les g√©n√©rations futures."
      },
      {
        topic: "Gi√° tr·ªã c·ªßa t√¨nh b·∫°n",
        text: "On dit souvent que les amis sont la famille que l'on choisit. Une amiti√© v√©ritable est l'une des choses les plus pr√©cieuses dans la vie d'une personne. Un vrai ami est quelqu'un qui est l√† pour vous dans les moments difficiles, qui vous √©coute sans vous juger et qui partage vos joies comme vos peines. Avec le temps et la distance, il est parfois difficile de garder le contact, mais les liens forts r√©sistent √† tout. Ce n'est pas la quantit√© d'amis qui compte, mais la qualit√©. Avoir une personne sur qui compter, avec qui rire et pleurer, est un cadeau inestimable qui rend la vie beaucoup plus douce."
      }
    ];

    let currentIdx = 0;
    let mediaRecorder;
    let fullTranscript = "";
    let timerInterval;
    const TIME_LIMIT = 60;
    let timeLeft = TIME_LIMIT;
    let streamReference = null;
    
    const contentWrapper = document.getElementById('content-wrapper');
    const textDisplayArea = document.getElementById('textDisplayArea');
    const mainBtn = document.getElementById('mainBtn');
    const nextBtn = document.getElementById('nextBtn');
    const timerDisplay = document.getElementById('timer');
    const topicDisplay = document.getElementById('topicDisplay');
    const resultModal = document.getElementById('resultModal');
    const modalScore = document.getElementById('modalScore');
    const modalMsg = document.getElementById('modalMsg');
    const debugInfo = document.getElementById('debugInfo');

    // ‚úÖ ƒê∆†N GI·∫¢N: Ch·ªâ normalize b·ªè d·∫•u c√¢u
    function normalizeWord(word) {
      return word.toLowerCase()
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()¬´¬ª""'']/g, '')
        .trim();
    }

    function loadText(index) {
      const data = readingLibrary[index];
      topicDisplay.textContent = data.topic;
      
      const words = data.text.trim().split(/\s+/);
      contentWrapper.innerHTML = '';
      words.forEach(word => {
        const span = document.createElement('span');
        span.className = 'word';
        span.textContent = word;
        span.dataset.clean = normalizeWord(word); 
        contentWrapper.appendChild(span);
      });

      textDisplayArea.className = 'text-display';
      contentWrapper.className = '';
      timerDisplay.textContent = "01:00";
      mainBtn.disabled = false;
      mainBtn.textContent = "D√©marrer (B·∫Øt ƒë·∫ßu)";
      mainBtn.className = "btn btn-main";
      timeLeft = TIME_LIMIT;
      debugInfo.style.display = 'none';
      fullTranscript = "";
    }

    mainBtn.addEventListener('click', async () => {
      if (mainBtn.classList.contains('btn-retry')) {
        loadText(currentIdx);
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        streamReference = stream;
        startSession(stream);
      } catch (err) {
        alert("L·ªói Micro: " + err.message);
      }
    });

    nextBtn.addEventListener('click', () => {
      forceStop();
      randomizeLesson();
    });

    function randomizeLesson() {
      let newIdx;
      do {
        newIdx = Math.floor(Math.random() * readingLibrary.length);
      } while (newIdx === currentIdx && readingLibrary.length > 1);
      
      currentIdx = newIdx;
      loadText(currentIdx);
    }

    function forceStop() {
       clearInterval(timerInterval);
       if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
       if(streamReference) streamReference.getTracks().forEach(track => track.stop());
    }

    function startSession(stream) {
      mainBtn.disabled = true;
      mainBtn.textContent = "ƒêang nghe...";
      contentWrapper.classList.add('scrolling');
      debugInfo.style.display = 'block';
      debugInfo.textContent = 'üé§ ƒêang ghi √¢m...';

      fullTranscript = "";
      
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      
      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) sendToIBM(e.data);
      };

      mediaRecorder.start(3000);

      timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
        
        if (timeLeft <= 0) finishSession();
      }, 1000);
    }

    async function sendToIBM(blob) {
      const formData = new FormData();
      formData.append('audio', blob, 'chunk.webm');
      try {
        const res = await fetch('/api/transcribe', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.text) {
          fullTranscript += " " + data.text;
          debugInfo.textContent = `üé§ IBM nghe ƒë∆∞·ª£c: "${data.text}"\nüìä T·ªïng: ${fullTranscript.trim().split(/\s+/).length} t·ª´`;
        }
      } catch (e) { 
        console.error(e);
        debugInfo.textContent = `‚ùå L·ªói: ${e.message}`;
      }
    }

    function finishSession() {
      clearInterval(timerInterval);
      
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
      
      if(streamReference) {
        streamReference.getTracks().forEach(track => track.stop());
      }
      
      mainBtn.textContent = "ƒêang ch·∫•m ƒëi·ªÉm...";
      debugInfo.textContent = '‚è≥ ƒêang ph√¢n t√≠ch...';
      
      setTimeout(calculateResult, 2500);
    }

    // ‚úÖ LOGIC ƒê∆†N GI·∫¢N: IBM nghe ƒë∆∞·ª£c = XANH, kh√¥ng nghe ƒë∆∞·ª£c = ƒê·ªé
    function calculateResult() {
      const spokenWords = fullTranscript.toLowerCase()
        .split(/\s+/)
        .map(w => w.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()¬´¬ª""'']/g, ''))
        .filter(w => w.length > 1);

      const domWords = document.querySelectorAll('.word');
      let correctCount = 0;

      debugInfo.textContent = `üîç So s√°nh:\nüìù Text g·ªëc: ${domWords.length} t·ª´\nüé§ IBM nghe ƒë∆∞·ª£c: ${spokenWords.length} t·ª´\n\nüìã Chi ti·∫øt: ${spokenWords.join(', ')}`;

      domWords.forEach(span => {
        const original = span.dataset.clean;
        if (!original || original.length <= 1) return;

        // ‚úÖ ƒê√öNG = IBM c√≥ nghe t·ª´ n√†y kh√¥ng?
        if (spokenWords.includes(original)) {
          span.classList.add('correct');
          correctCount++;
        } else {
          span.classList.add('wrong');
        }
      });

      const score = Math.round((correctCount / domWords.length) * 100);

      resultModal.className = 'result-modal active';
      resultModal.classList.remove('french-mode', 'chicken-mode');
      
      if (score >= 50) {
        resultModal.classList.add('french-mode');
        modalMsg.innerHTML = "Ch√∫c m·ª´ng!<br>B·∫°n l√† ng∆∞·ªùi Ph√°p üá´üá∑üç∑";
      } else {
        resultModal.classList.add('chicken-mode');
        modalMsg.innerHTML = "Chia bu·ªìn!<br>B·∫°n l√† con g√† e üêîü§£";
      }
      modalScore.textContent = `${score}%`;

      mainBtn.disabled = false;
      mainBtn.textContent = "üîÑ L√†m l·∫°i";
      mainBtn.classList.add('btn-retry');
      mainBtn.classList.remove('btn-main');
      
      debugInfo.textContent = `‚úÖ K·∫øt qu·∫£:\nüü¢ Ph√°t √¢m ƒë√∫ng: ${correctCount}/${domWords.length}\nüî¥ Ch∆∞a ƒë√∫ng: ${domWords.length - correctCount}`;
    }

    function closeResult() {
      resultModal.style.display = 'none';
      textDisplayArea.classList.add('review-mode');
    }

    window.onload = function() {
      randomizeLesson();
    };
  </script>
</body>
</html>
