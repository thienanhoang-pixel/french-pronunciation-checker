<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luy·ªán Ph√°t √Çm (Avec Ann)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body { height: 100%; width: 100%; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      /* N·∫øu b·∫°n mu·ªën d√πng ·∫£nh Dragon Ball th√¨ ƒë·ªïi t√™n file ·∫£nh ƒë√≥ th√†nh bg.jpg */
      background: url('bg.jpg') no-repeat center center fixed; 
      background-size: cover;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      color: #fff;
    }

    /* L·ªõp ph·ªß t·ªëi ƒë·ªÉ l√†m n·ªïi ch·ªØ */
    .overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); 
      z-index: 0;
    }

    .app-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 24px;
      position: relative;
      z-index: 1;
    }

    .header { text-align: center; margin-bottom: 20px; }

    /* Hi·ªáu ·ª©ng ch·ªØ Neon */
    .header h1 {
      color: #fff;
      font-size: 38px;
      font-weight: 800;
      text-transform: uppercase;
      text-shadow: 
        0 0 5px #fff,
        0 0 10px #fff,
        0 0 20px #ff00de,
        0 0 40px #ff00de;
      margin-bottom: 15px;
    }

    .slogan {
      font-size: 16px;
      font-weight: 600;
      background: rgba(0, 0, 0, 0.7);
      display: inline-block;
      padding: 8px 20px;
      border-radius: 50px;
      border: 1px solid #00ffea;
      box-shadow: 0 0 10px #00ffea;
      color: #00ffea;
      margin-bottom: 10px;
    }

    .api-status {
      margin-top: 5px;
      background: rgba(0, 0, 0, 0.8);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      display: inline-block;
      color: #aaa;
    }
    .api-status.active { color: #48bb78; border: 1px solid #48bb78; }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
      min-height: 0; /* Quan tr·ªçng ƒë·ªÉ flex kh√¥ng b·ªã tr√†n */
    }

    .text-display-wrapper {
      flex: 1;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      margin-bottom: 20px;
      position: relative;
      border: 2px solid rgba(255,255,255,0.2);
    }

    .text-display {
      height: 100%;
      overflow: hidden;
      position: relative;
      padding: 30px;
      display: flex;
      align-items: flex-end; /* Ch·ªØ ch·∫°y t·ª´ d∆∞·ªõi l√™n */
    }

    .text-content {
      width: 100%;
      padding-bottom: 50px; /* Kho·∫£ng tr·ªëng ƒë·ªÉ d·ªÖ nh√¨n */
      transform: translateY(100%);
      transition: none;
    }
    .text-content.scrolling { transition: transform 60s linear; transform: translateY(-100%); }

    .word {
      display: inline;
      font-size: 24px;
      line-height: 1.8;
      padding: 2px 4px;
      border-radius: 4px;
      color: #333;
    }
    .word.correct { background-color: #48bb78; color: #fff; font-weight: 600; }
    .word.current { background-color: #ffd700; color: #000; font-weight: 700; transform: scale(1.1); display: inline-block;}

    .controls {
      display: flex; gap: 12px; align-items: center; justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 15px; flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px; font-size: 16px; font-weight: 600; border: none; border-radius: 10px;
      cursor: pointer; transition: 0.2s; min-width: 110px;
    }
    .btn-start { background: #00ffea; color: #000; box-shadow: 0 0 10px #00ffea; }
    .btn-start:hover { transform: scale(1.05); background: #fff; }
    
    .btn-reset { background: #ff00de; color: #fff; box-shadow: 0 0 10px #ff00de; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

    .timer {
      font-size: 24px; font-weight: 700; color: #fff; min-width: 70px; text-align: center;
      text-shadow: 0 0 10px cyan;
    }

    .stats {
      background: rgba(0, 0, 0, 0.8);
      padding: 12px; border-radius: 16px;
      display: flex; justify-content: space-around;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .stat-label { font-size: 12px; color: #bbb; margin-bottom: 4px; }
    .stat-value { font-size: 20px; font-weight: 700; color: #fff; }
    .stat-value.correct { color: #48bb78; text-shadow: 0 0 10px #48bb78; }

    /* POPUP K·∫æT QU·∫¢ */
    .result-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      display: none;
      align-items: center; justify-content: center;
      backdrop-filter: blur(5px);
    }
    .result-modal.active { display: flex; animation: fadeIn 0.3s; }

    .result-box {
      background: #fff; color: #333; padding: 30px; border-radius: 20px;
      text-align: center; max-width: 450px; width: 90%;
      box-shadow: 0 0 40px rgba(0, 255, 234, 0.4);
      border: 4px solid #00ffea;
    }
    .result-score { font-size: 50px; font-weight: 900; margin: 15px 0; }
    .result-msg { font-size: 20px; font-weight: 600; line-height: 1.4; margin-bottom: 25px; }
    
    .french-mode .result-box { border-color: #48bb78; box-shadow: 0 0 40px #48bb78; }
    .french-mode .result-score { color: #48bb78; }
    
    .chicken-mode .result-box { border-color: #ff4757; box-shadow: 0 0 40px #ff4757; }
    .chicken-mode .result-score { color: #ff4757; }

    .btn-close { background: #333; color: white; padding: 10px 25px; border-radius: 50px; font-size: 16px; cursor: pointer; border: none; }

    /* Recording Dot */
    .recording-indicator {
      position: fixed; bottom: 20px; right: 20px;
      background: #ff4757; color: white; padding: 10px 20px;
      border-radius: 50px; display: none; align-items: center; gap: 10px;
      box-shadow: 0 0 20px #ff4757; z-index: 1001; font-weight: bold;
    }
    .recording-indicator.active { display: flex; }
    .pulse { width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.4); } 100% { opacity: 1; transform: scale(1); } }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>
  <div class="overlay"></div>
  
  <div class="app-container">
    <header class="header">
      <h1>üá´üá∑ Avec Ann üá´üá∑</h1>
      <div class="slogan">ü§µ B·∫°n l√† ng∆∞·ªùi Ph√°p hay l√† con g√†e? üêî</div>
      <br>
      <div class="api-status" id="apiStatus">ü§ñ Ready</div>
    </header>

    <main class="main-content">
      <div class="text-display-wrapper">
        <div class="text-display">
          <div class="text-content" id="textContent"></div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-start" id="startBtn">D√©marrer (B·∫Øt ƒë·∫ßu)</button>
        <div class="timer"><span id="timerDisplay">1:00</span></div>
        <button class="btn btn-reset" id="resetBtn">B√†i kh√°c ></button>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-label">Ch√≠nh x√°c</div>
          <div class="stat-value" id="accuracyDisplay">0%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ƒê√∫ng</div>
          <div class="stat-value correct" id="correctDisplay">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">S√≥t</div>
          <div class="stat-value" id="unreadDisplay">0</div>
        </div>
      </div>
    </main>
  </div>

  <div class="recording-indicator" id="recordingIndicator">
    <div class="pulse"></div><span>ƒêang nghe...</span>
  </div>

  <div class="result-modal" id="resultModal">
    <div class="result-box">
      <div class="result-title" style="font-weight:bold; font-size: 24px;">K·∫æT QU·∫¢</div>
      <div class="result-score" id="modalScore">0%</div>
      <div class="result-msg" id="modalMsg">...</div>
      <button class="btn-close" onclick="closeModal()">ƒê√≥ng</button>
    </div>
  </div>

  <script>
    // --- PH·∫¶N LOGIC JAVASCRIPT ---
    const frenchTexts = [
      { text: "Bonjour je m'appelle Marie. J'habite √† Paris. J'aime beaucoup le chocolat et les croissants." },
      { text: "Apprendre une nouvelle langue est comme ouvrir une fen√™tre sur un monde inconnu." },
      { text: "Chaque jour est une opportunit√© pour progresser. Il ne faut pas avoir peur de faire des erreurs." }
    ];

    let currentText = [];
    let isRunning = false;
    let timeRemaining = 60;
    let timerInterval = null;
    let stats = { correct: 0 };
    
    // UI Elements
    const textContent = document.getElementById('textContent');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const accuracyDisplay = document.getElementById('accuracyDisplay');
    const correctDisplay = document.getElementById('correctDisplay');
    const unreadDisplay = document.getElementById('unreadDisplay');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const resultModal = document.getElementById('resultModal');
    const modalScore = document.getElementById('modalScore');
    const modalMsg = document.getElementById('modalMsg');

    // Audio Vars
    let stream = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingTimeout = null;

    function closeModal() { resultModal.classList.remove('active'); }

    function normalizeText(text) {
      return text ? text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ').trim() : '';
    }
    
    // So s√°nh t·ª´ (Levenshtein ƒë∆°n gi·∫£n h√≥a)
    function calculateSimilarity(s1, s2) {
      if(!s1 || !s2) return 0;
      if(s1 === s2) return 1;
      // Logic so s√°nh ƒë∆°n gi·∫£n ƒë·ªÉ code g·ªçn
      let longer = s1.length > s2.length ? s1 : s2;
      let shorter = s1.length > s2.length ? s2 : s1;
      if (longer.length === 0) return 1.0;
      // Edit distance implementation
      let costs = new Array();
      for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
          if (i == 0) costs[j] = j;
          else {
            if (j > 0) {
              let newValue = costs[j - 1];
              if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
              costs[j - 1] = lastValue;
              lastValue = newValue;
            }
          }
        }
        if (i > 0) costs[s2.length] = lastValue;
      }
      return (longer.length - costs[s2.length]) / longer.length;
    }

    function markWordCorrect(i) {
      const el = document.getElementById(`word-${i}`);
      if (!el || el.classList.contains('correct')) return;
      el.classList.remove('current');
      el.classList.add('correct');
      stats.correct++;
    }

    function updateStats() {
      const total = currentText.length;
      const acc = total > 0 ? Math.round((stats.correct / total) * 100) : 0;
      accuracyDisplay.textContent = `${acc}%`;
      correctDisplay.textContent = stats.correct;
      unreadDisplay.textContent = Math.max(0, total - stats.correct);
      return acc;
    }

    async function recordLoop() {
      if (!isRunning) return;
      
      // Kh·ªüi t·∫°o Mic
      if (!stream) stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      
      const options = MediaRecorder.isTypeSupported('audio/webm') ? { mimeType: 'audio/webm' } : {};
      mediaRecorder = new MediaRecorder(stream, options);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        if (!isRunning || audioChunks.length === 0) return;
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        
        // G·ª≠i l√™n API (L∆∞u √Ω: Netlify function path c√≥ th·ªÉ kh√°c Vercel)
        recordingIndicator.classList.add('active');
        try {
            const formData = new FormData();
            formData.append('audio', blob, 'audio.webm');
            
            // QUAN TR·ªåNG: ƒê∆∞·ªùng d·∫´n API tr√™n Netlify
            // N·∫øu b·∫°n deploy t·ª´ code c≈© Vercel, API c√≥ th·ªÉ b·ªã l·ªói 404 ·ªü ƒë√¢y
            const res = await fetch('/api/transcribe', { method: 'POST', body: formData });
            if(res.ok) {
                const data = await res.json();
                if(data.text) checkText(data.text);
            }
        } catch(e) { console.error(e); }
        recordingIndicator.classList.remove('active');

        if (isRunning && timeRemaining > 0) setTimeout(recordLoop, 100);
      };

      mediaRecorder.start();
      setTimeout(() => { if(mediaRecorder.state==='recording') mediaRecorder.stop(); }, 2500);
    }

    function checkText(spoken) {
      const spokenWords = normalizeText(spoken).split(' ');
      let currentIndex = -1;
      // T√¨m t·ª´ ch∆∞a ƒë·ªçc
      for(let i=0; i<currentText.length; i++) {
          if(!document.getElementById(`word-${i}`).classList.contains('correct')) {
              currentIndex = i; break;
          }
      }
      if(currentIndex === -1) return stopGame(); // Xong h·∫øt r·ªìi

      // So kh·ªõp
      for(let w of spokenWords) {
          if(currentIndex >= currentText.length) break;
          const target = normalizeText(currentText[currentIndex]);
          if(calculateSimilarity(w, target) > 0.7) {
              markWordCorrect(currentIndex);
              currentIndex++;
          }
      }
      
      // Update Current Highlight
      document.querySelectorAll('.word').forEach(e => e.classList.remove('current'));
      if(currentIndex < currentText.length) {
          document.getElementById(`word-${currentIndex}`).classList.add('current');
      }
      
      if(updateStats() === 100) stopGame();
    }

    function startGame() {
      if(isRunning) return;
      isRunning = true;
      timeRemaining = 60;
      stats.correct = 0;
      document.querySelectorAll('.word').forEach(w => w.classList.remove('correct', 'current'));
      
      startBtn.disabled = true;
      textContent.classList.add('scrolling');
      
      // Reset Highlight
      document.getElementById('word-0').classList.add('current');

      timerInterval = setInterval(() => {
        timeRemaining--;
        timerDisplay.textContent = `0:${timeRemaining.toString().padStart(2, '0')}`;
        if(timeRemaining <= 0) stopGame();
      }, 1000);

      recordLoop();
    }

    function stopGame() {
      isRunning = false;
      clearInterval(timerInterval);
      try { if(mediaRecorder) mediaRecorder.stop(); } catch(e){}
      try { if(stream) stream.getTracks().forEach(t=>t.stop()); stream=null; } catch(e){}
      
      startBtn.disabled = false;
      textContent.classList.remove('scrolling');
      
      const finalScore = updateStats();
      resultModal.className = 'result-modal active ' + (finalScore >= 50 ? 'french-mode' : 'chicken-mode');
      modalScore.textContent = finalScore + '%';
      modalMsg.innerHTML = finalScore >= 50 ? "Ch√∫c m·ª´ng!<br>B·∫°n l√† ng∆∞·ªùi Ph√°p üá´üá∑" : "Chia bu·ªìn!<br>B·∫°n l√† con g√†e üêî";
    }

    function init() {
      const t = frenchTexts[Math.floor(Math.random()*frenchTexts.length)].text;
      currentText = t.split(' ');
      textContent.innerHTML = currentText.map((w,i) => `<span class="word" id="word-${i}">${w} </span>`).join('');
    }

    startBtn.onclick = startGame;
    resetBtn.onclick = () => { stopGame(); closeModal(); init(); };
    init();
  </script>
</body>
</html>
