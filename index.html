<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check Prononciation Avec Ann</title>
  <link rel="icon" href="favicon.png" type="image/png">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body { height: 100%; width: 100%; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('bg.jpg') no-repeat center center fixed; 
      background-size: cover;
      display: flex; flex-direction: column; overflow: hidden; color: #fff;
    }

    .overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); z-index: 0;
    }

    .app-container {
      width: 100%; height: 100%; display: flex; flex-direction: column;
      padding: 24px; position: relative; z-index: 1;
    }

    .header { text-align: center; margin-bottom: 10px; flex-shrink: 0; }

    .header h1 {
      color: #fff; font-size: 32px; font-weight: 800; text-transform: uppercase;
      text-shadow: 0 0 5px #fff, 0 0 20px #ff00de; margin-bottom: 5px;
      letter-spacing: 1px;
    }

    .slogan {
      font-size: 14px; font-weight: 600; background: rgba(0, 0, 0, 0.7);
      display: inline-block; padding: 5px 15px; border-radius: 50px;
      border: 1px solid #00ffea; color: #00ffea;
    }

    .main-content {
      flex: 1; display: flex; flex-direction: column;
      max-width: 900px; width: 100%; margin: 0 auto; min-height: 0;
    }

    /* KHUNG HI·ªÇN TH·ªä VƒÇN B·∫¢N */
    .text-display-wrapper {
      flex: 1; background: rgba(255, 255, 255, 0.95);
      border-radius: 16px; 
      overflow: hidden; 
      margin-bottom: 15px; position: relative;
      border: 2px solid rgba(255,255,255,0.2);
      display: flex; flex-direction: column;
    }

    .text-display {
      flex: 1; position: relative; padding: 0 40px; overflow-y: hidden; display: block; 
    }

    .text-display.review-mode {
      overflow-y: auto; padding-top: 20px; padding-bottom: 20px;
    }

    #content-wrapper {
      width: 100%; text-align: justify;
      position: absolute; top: 100%; left: 0; right: 0;
      padding-bottom: 100px;
    }

    .review-mode #content-wrapper {
      position: relative; top: 0 !important; transform: none !important; animation: none !important;
    }

    .scrolling { animation: scrollUp 60s linear forwards; }
    @keyframes scrollUp { 
      from { top: 100%; transform: translateY(0); } 
      to { top: 0; transform: translateY(-100%); } 
    }

    .word {
      display: inline-block; font-size: 24px; line-height: 1.8;
      padding: 0 2px; border-radius: 4px; color: #333; margin-right: 4px;
    }
    .word.correct { background-color: #48bb78; color: #fff; }
    .word.wrong { color: #e53e3e; text-decoration: line-through; opacity: 0.6; }

    .controls {
      display: flex; gap: 15px; align-items: center; justify-content: center;
      background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 16px; flex-shrink: 0;
    }

    .btn {
      padding: 12px 24px; font-size: 16px; font-weight: bold; border: none; border-radius: 50px;
      cursor: pointer; transition: 0.2s; min-width: 130px;
    }
    .btn-main { background: #fbbf24; color: #744210; }
    .btn-main:hover { background: #fff; }
    .btn-next { background: #63b3ed; color: #fff; }
    
    .timer { font-size: 24px; font-weight: 700; color: #fff; min-width: 70px; text-align: center; }

    .result-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 2000; display: none;
      align-items: center; justify-content: center;
    }
    .result-modal.active { display: flex; }
    .result-box {
      background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 450px;
      border: 4px solid #ccc;
    }
    .result-score { font-size: 60px; font-weight: 900; margin: 15px 0; }
    .result-msg { font-size: 22px; font-weight: 600; line-height: 1.4; margin-bottom: 20px; }
    
    .french-mode .result-box { border-color: #48bb78; box-shadow: 0 0 30px #48bb78; }
    .french-mode .result-score { color: #48bb78; }
    
    .chicken-mode .result-box { border-color: #ff4757; box-shadow: 0 0 30px #ff4757; }
    .chicken-mode .result-score { color: #ff4757; }

    .btn-close { background: #333; color: white; padding: 10px 25px; border-radius: 50px; border: none; cursor: pointer; margin-top: 15px; }
    
    .topic-badge {
      position: absolute; top: 10px; left: 10px; 
      background: #333; color: #fff; padding: 4px 10px; 
      border-radius: 4px; font-size: 12px; z-index: 10;
      text-transform: uppercase; letter-spacing: 1px;
    }
  </style>
</head>
<body>
  <div class="overlay"></div>
  
  <div class="app-container">
    <header class="header">
      <h1>CHECK PRONONCIATION AVEC ANN</h1>
      <div class="slogan">ü§µ B·∫°n l√† ng∆∞·ªùi Ph√°p hay l√† con g√†e? üêî</div>
    </header>

    <main class="main-content">
      <div class="text-display-wrapper">
        <div class="topic-badge" id="topicDisplay">Topic</div>
        <div class="timer" id="timer" style="position: absolute; top: 10px; right: 10px; color: #333; z-index: 10;">01:00</div>
        
        <div class="text-display" id="textDisplayArea">
          <div id="content-wrapper"></div>
        </div>
      </div>

      <div class="controls">
        <button id="mainBtn" class="btn btn-main">D√©marrer (B·∫Øt ƒë·∫ßu)</button>
        <button id="nextBtn" class="btn btn-next">B√†i kh√°c (Autres) ></button>
      </div>
    </main>
  </div>

  <div class="result-modal" id="resultModal">
    <div class="result-box">
      <h2>K·∫æT QU·∫¢</h2>
      <div class="result-score" id="modalScore">0%</div>
      <div class="result-msg" id="modalMsg">...</div>
      <button class="btn-close" onclick="closeResult()">Xem l·∫°i l·ªói sai</button>
    </div>
  </div>

  <script>
    // ==========================================
    // TH∆Ø VI·ªÜN B√ÄI ƒê·ªåC
    // ==========================================
    const readingLibrary = [
      { topic: "Kh√°m ph√° Paris", text: "Paris est souvent appel√©e la ville lumi√®re, et pour cause. Quand le soleil se couche, les monuments s'illuminent et cr√©ent une atmosph√®re magique et romantique. Se promener sur les quais de la Seine est une exp√©rience inoubliable pour les touristes du monde entier. On peut admirer la cath√©drale Notre-Dame, le mus√©e du Louvre et bien s√ªr, la majestueuse tour Eiffel qui brille dans la nuit. Mais Paris, ce n'est pas seulement des monuments. C'est aussi l'odeur du caf√© frais le matin, les boulangeries qui vendent des croissants chauds et les artistes qui peignent dans les rues de Montmartre. C'est une ville qui vit, qui respire et qui inspire les po√®tes depuis des si√®cles." },
      { topic: "Ngh·ªá thu·∫≠t s·ªëng", text: "En France, la gastronomie est bien plus qu'une simple fa√ßon de se nourrir, c'est un v√©ritable art de vivre. Le repas est un moment sacr√© o√π la famille et les amis se r√©unissent pour partager du bonheur et des discussions anim√©es. On prend le temps de d√©guster chaque plat, de l'entr√©e au dessert, accompagn√© souvent d'un verre de vin rouge ou blanc. Les march√©s locaux regorgent de produits frais : des fromages vari√©s, des l√©gumes color√©s et des fruits d√©licieux. Cuisiner est un acte d'amour et de tradition. Chaque r√©gion poss√®de ses propres sp√©cialit√©s et ses secrets culinaires qui se transmettent de g√©n√©ration en g√©n√©ration avec fiert√©." },
      { topic: "L·ª£i √≠ch c·ªßa vi·ªác ƒë·ªçc s√°ch", text: "Dans notre monde moderne domin√© par les √©crans et la technologie, prendre le temps de lire un livre est devenu un luxe pr√©cieux. La lecture nous permet de voyager sans bouger de notre fauteuil. Elle ouvre notre esprit √† de nouvelles id√©es, enrichit notre vocabulaire et stimule notre imagination. Quand on lit un roman, on vit mille vies diff√©rentes, on ressent les √©motions des personnages et on oublie nos propres soucis quotidiens. Que ce soit de la po√©sie, de la science-fiction ou de l'histoire, chaque livre est une porte ouverte vers un autre univers. C'est une habitude qui calme l'esprit et nourrit l'√¢me en profondeur." },
      { topic: "B·∫£o v·ªá thi√™n nhi√™n", text: "La nature nous offre tout ce dont nous avons besoin pour vivre : l'air que nous respirons, l'eau que nous buvons et la nourriture que nous mangeons. Cependant, l'activit√© humaine menace aujourd'hui cet √©quilibre fragile. Les for√™ts disparaissent, les oc√©ans sont pollu√©s et le climat change rapidement. Il est urgent de changer nos habitudes pour prot√©ger notre belle plan√®te bleue. Des gestes simples peuvent faire une grande diff√©rence, comme r√©duire notre consommation de plastique, recycler nos d√©chets ou utiliser les transports en commun. Prot√©ger l'environnement, ce n'est pas seulement sauver les animaux, c'est aussi assurer un avenir sain et heureux pour nos enfants et les g√©n√©rations futures." },
      { topic: "Gi√° tr·ªã c·ªßa t√¨nh b·∫°n", text: "On dit souvent que les amis sont la famille que l'on choisit. Une amiti√© v√©ritable est l'une des choses les plus pr√©cieuses dans la vie d'une personne. Un vrai ami est quelqu'un qui est l√† pour vous dans les moments difficiles, qui vous √©coute sans vous juger et qui partage vos joies comme vos peines. Avec le temps et la distance, il est parfois difficile de garder le contact, mais les liens forts r√©sistent √† tout. Ce n'est pas la quantit√© d'amis qui compte, mais la qualit√©. Avoir une personne sur qui compter, avec qui rire et pleurer, est un cadeau inestimable qui rend la vie beaucoup plus douce." },
      { topic: "Du l·ªãch v√† tr·∫£i nghi·ªám", text: "Voyager est la meilleure √©cole de la vie. Quand on visite un pays √©tranger, on ne d√©couvre pas seulement de nouveaux paysages, on d√©couvre aussi une nouvelle fa√ßon de penser et de vivre. On apprend √† sortir de sa zone de confort, √† go√ªter des aliments inconnus et √† essayer de parler une autre langue. Ces exp√©riences nous rendent plus ouverts, plus tol√©rants et plus humbles. On r√©alise que malgr√© nos diff√©rences culturelles, les √™tres humains partagent les m√™mes r√™ves et les m√™mes √©motions partout sur la Terre. Le voyage nous change int√©rieurement et nous laisse des souvenirs grav√©s √† jamais dans notre m√©moire." },
      { topic: "Th·ªÉ thao v√† s·ª©c kh·ªèe", text: "Le sport joue un r√¥le essentiel pour maintenir une bonne sant√© physique et mentale. Pratiquer une activit√© physique r√©guli√®re aide √† r√©duire le stress, √† am√©liorer le sommeil et √† renforcer le c≈ìur. Que ce soit la course √† pied, la natation, le yoga ou le football, l'important est de bouger et de se faire plaisir. Le sport nous apprend aussi des valeurs importantes comme la discipline, le respect des r√®gles et l'esprit d'√©quipe. Se d√©passer, fixer des objectifs et voir ses progr√®s procure une grande satisfaction personnelle. Comme on dit souvent : un esprit sain dans un corps sain est la cl√© du bonheur." },
      { topic: "C√¥ng ngh·ªá v√† cu·ªôc s·ªëng", text: "La technologie a transform√© notre fa√ßon de vivre √† une vitesse incroyable. Aujourd'hui, nous pouvons communiquer instantan√©ment avec des personnes √† l'autre bout du monde, acc√©der √† toute la connaissance humaine en un clic et travailler depuis n'importe o√π. Cependant, cette connexion permanente a aussi ses inconv√©nients. Nous passons parfois plus de temps √† regarder nos t√©l√©phones qu'√† parler aux gens qui sont en face de nous. Il est important de trouver un √©quilibre. La technologie doit rester un outil pour nous servir, et non un ma√Ætre qui contr√¥le notre temps et notre attention. Savoir se d√©connecter est devenu une comp√©tence essentielle." },
      { topic: "H·∫°nh ph√∫c t·ª´ ƒëi·ªÅu gi·∫£n ƒë∆°n", text: "Beaucoup de gens cherchent le bonheur dans la richesse, la c√©l√©brit√© ou la r√©ussite professionnelle. Pourtant, le vrai bonheur se cache souvent dans les choses simples de la vie quotidienne. C'est l'odeur de la pluie en √©t√©, le sourire d'un enfant, un repas partag√© avec des proches ou une promenade tranquille dans la for√™t. Savoir appr√©cier l'instant pr√©sent est un secret que nous oublions trop souvent. La gratitude est une cl√© puissante : √™tre reconnaissant pour ce que l'on a, au lieu de toujours d√©sirer ce que l'on n'a pas. Le bonheur n'est pas une destination √† atteindre, c'est une mani√®re de voyager chaque jour." },
      { topic: "Gi·∫•c m∆° v√† n·ªó l·ª±c", text: "Avoir des r√™ves est ce qui donne un sens √† notre existence. Que ce soit devenir m√©decin, voyager autour du monde, √©crire un livre ou simplement fonder une famille heureuse, nos r√™ves nous poussent √† avancer. Mais r√™ver ne suffit pas, il faut aussi avoir le courage d'agir. Le chemin vers le succ√®s est souvent rempli d'obstacles et d'√©checs. Ce n'est pas grave de tomber, l'important est de se relever et de continuer √† essayer. La pers√©v√©rance et le travail acharn√© sont les cl√©s de la r√©ussite. Ne laissez jamais personne vous dire que vos r√™ves sont impossibles, car votre potentiel est infini." }
    ];

    // ==========================================
    // LOGIC H·ªÜ TH·ªêNG
    // ==========================================
    let currentIdx = 0;
    let mediaRecorder = null;
    let fullTranscript = "";
    let timerInterval = null;
    let chunkInterval = null;
    const TIME_LIMIT = 60;
    let timeLeft = TIME_LIMIT;
    let streamReference = null;
    let isProcessing = false;
    
    // DOM Elements
    const contentWrapper = document.getElementById('content-wrapper');
    const textDisplayArea = document.getElementById('textDisplayArea');
    const mainBtn = document.getElementById('mainBtn');
    const nextBtn = document.getElementById('nextBtn');
    const timerDisplay = document.getElementById('timer');
    const topicDisplay = document.getElementById('topicDisplay');
    const resultModal = document.getElementById('resultModal');
    const modalScore = document.getElementById('modalScore');
    const modalMsg = document.getElementById('modalMsg');

    // H√†m D·ª´ng kh·∫©n c·∫•p: X√≥a m·ªçi interval, stop ghi √¢m, reset bi·∫øn
    function forceStop() {
       clearInterval(timerInterval);
       clearInterval(chunkInterval);
       timerInterval = null;
       chunkInterval = null;
       isProcessing = false;
       fullTranscript = ""; // X√≥a d·ªØ li·ªáu c≈©
       
       if(mediaRecorder && mediaRecorder.state !== 'inactive') {
         mediaRecorder.stop();
       }
       if(streamReference) {
         streamReference.getTracks().forEach(track => track.stop());
       }
       
       mainBtn.disabled = false;
       mainBtn.textContent = "D√©marrer (B·∫Øt ƒë·∫ßu)";
       mainBtn.classList.remove('btn-retry');
       mainBtn.classList.add('btn-main');
       contentWrapper.classList.remove('scrolling');
    }

    function loadText(index) {
      forceStop(); // Reset s·∫°ch s·∫Ω tr∆∞·ªõc khi load b√†i m·ªõi
      
      const data = readingLibrary[index];
      topicDisplay.textContent = data.topic;
      const words = data.text.trim().split(/\s+/);
      contentWrapper.innerHTML = '';
      words.forEach(word => {
        const span = document.createElement('span');
        span.className = 'word';
        span.textContent = word;
        span.dataset.clean = normalizeWord(word); 
        contentWrapper.appendChild(span);
      });
      
      textDisplayArea.className = 'text-display';
      contentWrapper.className = '';
      timerDisplay.textContent = "01:00";
      timeLeft = TIME_LIMIT;
    }

    function normalizeWord(word) {
      return word.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "").replace(/\s+/g, "");
    }

    mainBtn.addEventListener('click', async () => {
      // N·∫øu l√† n√∫t "L√†m l·∫°i" -> Reset ngay l·∫≠p t·ª©c v√† load l·∫°i b√†i hi·ªán t·∫°i
      if (mainBtn.classList.contains('btn-retry')) {
        loadText(currentIdx);
        // Sau khi load xong, gi·∫£ l·∫≠p click start l·∫ßn n·ªØa n·∫øu mu·ªën, 
        // nh∆∞ng t·ªët nh·∫•t ƒë·ªÉ ng∆∞·ªùi d√πng t·ª± b·∫•m start l·∫°i cho chu·∫©n b·ªã.
        return; 
      }
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        streamReference = stream;
        startSession(stream);
      } catch (err) {
        alert("L·ªói Micro: " + err.message + "\nH√£y th·ª≠ d√πng Chrome/Edge n·∫øu C·ªëc C·ªëc b·ªã l·ªói.");
      }
    });

    nextBtn.addEventListener('click', () => {
      forceStop(); // D·ª´ng ngay l·∫≠p t·ª©c
      randomizeLesson();
    });

    function randomizeLesson() {
      let newIdx;
      do { newIdx = Math.floor(Math.random() * readingLibrary.length); } 
      while (newIdx === currentIdx && readingLibrary.length > 1);
      currentIdx = newIdx;
      loadText(currentIdx);
    }

    function startSession(stream) {
      mainBtn.disabled = true;
      mainBtn.textContent = "ƒêang nghe...";
      contentWrapper.classList.add('scrolling');
      fullTranscript = "";
      isProcessing = true;

      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) sendToIBM(e.data);
      };

      mediaRecorder.start();

      // C·∫Øt file m·ªói 4 gi√¢y
      chunkInterval = setInterval(() => {
        if (mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            if (timeLeft > 0 && isProcessing) {
                mediaRecorder.start();
            }
        }
      }, 4000);

      timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
        
        // H·∫øt gi·ªù -> D·ª´ng ngay
        if (timeLeft <= 0) {
            finishSession();
        }
      }, 1000);
    }

    async function sendToIBM(blob) {
      if (blob.size < 1000) return;
      const formData = new FormData();
      formData.append('audio', blob, 'chunk.webm');
      try {
        const res = await fetch('/api/transcribe', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.text) {
            console.log("Nghe ƒë∆∞·ª£c:", data.text);
            fullTranscript += " " + data.text;
        }
      } catch (e) { console.error(e); }
    }

    function finishSession() {
      // D·ª´ng h·∫øt c√°c ƒë·ªìng h·ªì
      clearInterval(timerInterval);
      clearInterval(chunkInterval);
      isProcessing = false;
      
      if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      if (streamReference) streamReference.getTracks().forEach(track => track.stop());
      
      mainBtn.textContent = "ƒêang ch·∫•m ƒëi·ªÉm...";
      
      // ƒê·ª£i 3s ƒë·ªÉ IBM tr·∫£ v·ªÅ n·ªët c√°c chunk cu·ªëi
      setTimeout(calculateResult, 3000); 
    }

    function calculateResult() {
      const allSpokenWords = fullTranscript.toLowerCase();
      const domWords = document.querySelectorAll('.word');
      let correctCount = 0;

      domWords.forEach(span => {
        const original = span.dataset.clean;
        if (original && allSpokenWords.includes(original)) {
          span.classList.add('correct');
          correctCount++;
        } else {
          span.classList.add('wrong');
        }
      });

      const score = Math.round((correctCount / domWords.length) * 100);

      // --- KH√îI PH·ª§C LOGIC C√ÇU ƒê√ôA ---
      resultModal.className = 'result-modal active';
      resultModal.classList.remove('french-mode', 'chicken-mode');
      
      if (score >= 50) {
        resultModal.classList.add('french-mode');
        // Icon ng∆∞·ªùi Ph√°p + c√¢u ch√∫c
        modalMsg.innerHTML = "Ch√∫c m·ª´ng, b·∫°n l√† ng∆∞·ªùi Ph√°p üá´üá∑üç∑";
      } else {
        resultModal.classList.add('chicken-mode');
        // Icon con g√† + c√¢u tr√™u
        modalMsg.innerHTML = "L√™u l√™u, b·∫°n l√† con g√†e üêîü§£";
      }
      modalScore.textContent = `${score}%`;

      mainBtn.disabled = false;
      mainBtn.textContent = "üîÑ L√†m l·∫°i";
      mainBtn.classList.add('btn-retry');
      mainBtn.classList.remove('btn-main');
    }

    function closeResult() {
      resultModal.style.display = 'none';
      textDisplayArea.classList.add('review-mode');
    }

    window.onload = function() { randomizeLesson(); };
  </script>
</body>
</html>
