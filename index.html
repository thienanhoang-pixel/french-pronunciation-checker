<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luy·ªán N√≥i Ti·∫øng Ph√°p - Free Style</title>
  <style>
    /* --- GI·ªÆ NGUY√äN CSS C≈® V√Ä C·∫¨P NH·∫¨T PH·∫¶N TEXT --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; width: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      color: #333;
    }

    .app-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 24px;
      max-width: 800px;
      margin: 0 auto;
    }

    .header { text-align: center; margin-bottom: 20px; color: white; }
    .header h1 { font-size: 28px; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    /* Khu v·ª±c hi·ªÉn th·ªã vƒÉn b·∫£n */
    .text-display-area {
      flex: 1;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden; /* Quan tr·ªçng ƒë·ªÉ che ph·∫ßn text tr√¥i ƒëi */
      display: flex;
      align-items: flex-start; /* B·∫Øt ƒë·∫ßu t·ª´ tr√™n c√πng */
      justify-content: center;
    }

    /* Container ch·ª©a n·ªôi dung ch·ªØ s·∫Ω tr√¥i */
    #content-wrapper {
      font-size: 24px;
      line-height: 1.8;
      color: #4a5568;
      text-align: justify;
      position: absolute;
      top: 0;
      left: 30px;
      right: 30px;
      padding-top: 150px; /* Kho·∫£ng ƒë·ªám ƒë·ªÉ ch·ªØ b·∫Øt ƒë·∫ßu t·ª´ gi·ªØa */
    }

    /* Hi·ªáu ·ª©ng tr√¥i ch·ªØ */
    .scrolling {
      animation: scrollUp 60s linear forwards; /* ƒê√∫ng 60 gi√¢y */
    }

    @keyframes scrollUp {
      from { transform: translateY(0); }
      to { transform: translateY(-100%); } /* Tr√¥i h·∫øt b√†i */
    }

    /* Style cho t·ª´ ng·ªØ */
    .word {
      display: inline-block;
      margin-right: 5px;
      transition: all 0.3s ease;
      padding: 2px 4px;
      border-radius: 4px;
    }

    /* Ch·ªâ hi·ªán m√†u xanh khi k·∫øt th√∫c */
    .word.correct {
      background-color: #48bb78;
      color: white;
      transform: scale(1.1);
      font-weight: bold;
    }

    /* Footer controls */
    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 10px;
    }

    .btn {
      border: none;
      padding: 15px 40px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .btn-primary { background: #fbbf24; color: #744210; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .btn-danger { background: #fc8181; color: white; display: none; }

    .timer {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      z-index: 10;
    }

    /* Th√¥ng b√°o k·∫øt qu·∫£ */
    .result-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
      flex-direction: column;
    }
    .result-box {
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .result-score { font-size: 48px; color: #48bb78; font-weight: bold; margin: 20px 0; }
    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  </style>
</head>
<body>

  <div class="app-container">
    <div class="header">
      <h1>üá´üá∑ Luy·ªán Ph√°t √Çm Ti·∫øng Ph√°p</h1>
      <p>ƒê·ªçc to ƒëo·∫°n vƒÉn b√™n d∆∞·ªõi. K·∫øt qu·∫£ s·∫Ω c√≥ sau 60 gi√¢y.</p>
    </div>

    <div class="text-display-area">
      <div class="timer" id="timer">01:00</div>
      <div id="content-wrapper">
        </div>
    </div>

    <div class="controls">
      <button id="startBtn" class="btn btn-primary">D√©marrer (B·∫Øt ƒë·∫ßu)</button>
      <button id="resetBtn" class="btn btn-danger" style="display:block; background:#e53e3e;">L√†m l·∫°i</button>
    </div>
  </div>

  <div class="result-overlay" id="resultOverlay">
    <div class="result-box">
      <h2>K·∫øt qu·∫£ c·ªßa b·∫°n</h2>
      <div class="result-score" id="finalScore">0%</div>
      <p id="wordCountMsg">B·∫°n ƒë·ªçc ƒë√∫ng 0/0 t·ª´</p>
      <button class="btn btn-primary" onclick="closeResult()">Xem chi ti·∫øt</button>
    </div>
  </div>

  <script>
    // --- B√ÄI ƒê·ªåC √ù NGHƒ®A (Kho·∫£ng 150 t·ª´ - V·ª´a v·∫∑n 1 ph√∫t) ---
    const frenchText = `
      Apprendre une nouvelle langue est comme ouvrir une fen√™tre sur un monde inconnu. 
      C‚Äôest une aventure passionnante qui demande du courage et de la patience. 
      Quand on parle fran√ßais, on d√©couvre la culture de la France, la beaut√© de Paris 
      et l‚Äôhistoire des grands √©crivains comme Victor Hugo. 
      
      Chaque jour est une opportunit√© pour progresser. 
      Il ne faut pas avoir peur de faire des erreurs, car c‚Äôest en tombant qu‚Äôon apprend √† marcher. 
      √âcoutez de la musique, regardez des films et parlez avec des amis. 
      La prononciation peut √™tre difficile au d√©but, mais avec de la pratique, 
      votre voix deviendra naturelle et fluide. 
      
      Le voyage est plus important que la destination. 
      Alors, respirez profond√©ment, souriez et commencez √† lire ce texte avec confiance. 
      Votre effort aujourd'hui sera votre succ√®s de demain. 
      Bonne chance et amusez-vous bien !
    `;

    // Bi·∫øn to√†n c·ª•c
    let mediaRecorder;
    let isRecording = false;
    let recordedChunks = []; // D√πng ƒë·ªÉ g·ª≠i file ghi √¢m t·ª´ng ƒëo·∫°n
    let fullTranscript = ""; // Bi·∫øn ch·ª©a T·∫§T C·∫¢ nh·ªØng g√¨ ng∆∞·ªùi d√πng n√≥i
    let timerInterval;
    let recordingInterval;
    const TIME_LIMIT = 60; // 60 gi√¢y
    let timeLeft = TIME_LIMIT;

    const contentWrapper = document.getElementById('content-wrapper');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const timerDisplay = document.getElementById('timer');
    const resultOverlay = document.getElementById('resultOverlay');

    // 1. Kh·ªüi t·∫°o b√†i ƒë·ªçc
    function initText() {
      // L√†m s·∫°ch text v√† t√°ch t·ª´
      const words = frenchText.trim().split(/\s+/);
      contentWrapper.innerHTML = '';
      words.forEach(word => {
        const span = document.createElement('span');
        span.className = 'word';
        span.textContent = word;
        // L∆∞u t·ª´ g·ªëc (b·ªè d·∫•u c√¢u) v√†o dataset ƒë·ªÉ so s√°nh sau n√†y
        span.dataset.clean = normalizeWord(word); 
        contentWrapper.appendChild(span);
      });
    }

    // H√†m chu·∫©n h√≥a t·ª´ (B·ªè d·∫•u c√¢u, v·ªÅ ch·ªØ th∆∞·ªùng) ƒë·ªÉ so s√°nh
    function normalizeWord(word) {
      return word.toLowerCase()
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "")
        .replace(/\s{2,}/g, " ");
    }

    // 2. B·∫Øt ƒë·∫ßu ch∆∞∆°ng tr√¨nh
    startBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        startSession(stream);
      } catch (err) {
        alert("Kh√¥ng th·ªÉ truy c·∫≠p Microphone. Vui l√≤ng c·∫•p quy·ªÅn!");
      }
    });

    function startSession(stream) {
      isRecording = true;
      fullTranscript = ""; // Reset k·∫øt qu·∫£ c≈©
      startBtn.disabled = true;
      startBtn.textContent = "ƒêang ghi √¢m...";
      
      // B·∫Øt ƒë·∫ßu hi·ªáu ·ª©ng tr√¥i ch·ªØ
      contentWrapper.classList.add('scrolling');

      // Kh·ªüi t·∫°o MediaRecorder
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

      mediaRecorder.ondataavailable = async (e) => {
        if (e.data.size > 0) {
          // G·ª≠i ngay ƒëo·∫°n v·ª´a n√≥i l√™n server
          sendToIBM(e.data); 
        }
      };

      // C·ª© 3 gi√¢y c·∫Øt file g·ª≠i l√™n server 1 l·∫ßn (ƒë·ªÉ tr√°nh m·∫•t d·ªØ li·ªáu n·∫øu file qu√° n·∫∑ng)
      mediaRecorder.start(); // B·∫Øt ƒë·∫ßu ghi
      recordingInterval = setInterval(() => {
        if(mediaRecorder.state === 'recording') {
          mediaRecorder.stop(); // D·ª´ng ƒë·ªÉ t·∫°o chunk
          mediaRecorder.start(); // Ghi ti·∫øp ngay l·∫≠p t·ª©c
        }
      }, 3000); 

      // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
      timeLeft = TIME_LIMIT;
      timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
        if (timeLeft <= 0) {
          finishSession();
        }
      }, 1000);
    }

    // 3. G·ª≠i Audio l√™n Backend (IBM Watson)
    async function sendToIBM(audioBlob) {
      const formData = new FormData();
      formData.append('audio', audioBlob, 'chunk.webm');

      try {
        const res = await fetch('/api/transcribe', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        
        if (data.text) {
          // C·ªông d·ªìn nh·ªØng g√¨ ng∆∞·ªùi d√πng n√≥i v√†o bi·∫øn t·ªïng
          fullTranscript += " " + data.text;
          console.log("ƒê√£ nghe ƒë∆∞·ª£c:", fullTranscript);
        }
      } catch (err) {
        console.error("L·ªói g·ª≠i API:", err);
      }
    }

    // 4. K·∫øt th√∫c phi√™n (H·∫øt gi·ªù)
    function finishSession() {
      isRecording = false;
      clearInterval(timerInterval);
      clearInterval(recordingInterval);
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
      
      // D·ª´ng hi·ªáu ·ª©ng tr√¥i
      contentWrapper.style.animationPlayState = 'paused'; 
      startBtn.textContent = "ƒê√£ xong!";

      // Ch·ªù m·ªôt ch√∫t ƒë·ªÉ API x·ª≠ l√Ω n·ªët ƒëo·∫°n cu·ªëi c√πng r·ªìi m·ªõi ch·∫•m ƒëi·ªÉm
      startBtn.textContent = "ƒêang ch·∫•m ƒëi·ªÉm...";
      setTimeout(() => {
        calculateResult();
      }, 2000); 
    }

    // 5. Ch·∫•m ƒëi·ªÉm (Logic Bag-of-Words)
    function calculateResult() {
      const allSpokenWords = fullTranscript.toLowerCase(); // Chu·ªói ng∆∞·ªùi d√πng n√≥i
      const domWords = document.querySelectorAll('.word');
      let correctCount = 0;

      domWords.forEach(span => {
        const originalWord = span.dataset.clean;
        
        // Logic ki·ªÉm tra: N·∫øu t·ª´ g·ªëc xu·∫•t hi·ªán trong ƒëo·∫°n vƒÉn ng∆∞·ªùi d√πng n√≥i
        // Ch√∫ng ta d√πng indexOf thay v√¨ includes ƒë·ªÉ t√¨m ch√≠nh x√°c h∆°n
        if (originalWord && allSpokenWords.includes(originalWord)) {
          span.classList.add('correct');
          correctCount++;
        }
      });

      // T√≠nh ƒëi·ªÉm
      const totalWords = domWords.length;
      const score = Math.round((correctCount / totalWords) * 100);

      // Hi·ªán popup
      document.getElementById('finalScore').textContent = `${score}%`;
      document.getElementById('wordCountMsg').textContent = `B·∫°n ƒë·ªçc ƒë√∫ng ${correctCount}/${totalWords} t·ª´`;
      resultOverlay.style.display = 'flex';
      
      startBtn.textContent = "D√©marrer (B·∫Øt ƒë·∫ßu)";
      startBtn.disabled = false;
    }

    // N√∫t l√†m l·∫°i
    resetBtn.addEventListener('click', () => {
      location.reload();
    });

    function closeResult() {
      resultOverlay.style.display = 'none';
      // Ng∆∞·ªùi d√πng c√≥ th·ªÉ nh√¨n th·∫•y text ƒë√£ ƒë∆∞·ª£c t√¥ m√†u xanh
    }

    // Ch·∫°y khi load trang
    initText();

  </script>
</body>
</html>
