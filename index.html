<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luy·ªán N√≥i Ti·∫øng Ph√°p</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; width: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    body {
      background: url('bg.jpg') no-repeat center center fixed; 
      background-size: cover; /* ƒê·ªÉ ·∫£nh ph·ªß k√≠n m√†n h√¨nh */
      display: flex;
      flex-direction: column;
      color: #333;
    }

    .app-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    .header { text-align: center; margin-bottom: 20px; color: white; }
    .header h1 { font-size: 28px; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    /* Khu v·ª±c hi·ªÉn th·ªã vƒÉn b·∫£n */
    .text-display-area {
      flex: 1;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden; 
      display: flex;
      justify-content: center;
    }

    /* Container ch·ª©a n·ªôi dung */
    #content-wrapper {
      font-size: 26px;
      line-height: 1.8;
      color: #4a5568;
      text-align: justify;
      position: absolute;
      top: 0; left: 30px; right: 30px;
      padding-top: 150px; /* Padding ƒë·ªÉ b·∫Øt ƒë·∫ßu t·ª´ gi·ªØa */
      transition: transform 0.5s ease; /* Hi·ªáu ·ª©ng khi reset v·ªã tr√≠ */
    }

    /* Class n√†y k√≠ch ho·∫°t hi·ªáu ·ª©ng tr√¥i */
    .scrolling {
      animation: scrollUp 60s linear forwards; 
    }

    @keyframes scrollUp {
      from { transform: translateY(0); }
      to { transform: translateY(-100%); }
    }

    /* --- STYLE CHO T·ª™ ƒê√öNG/SAI --- */
    .word {
      display: inline-block;
      margin-right: 6px;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.3s;
    }

    /* ƒê√∫ng: Xanh l√° */
    .word.correct {
      background-color: #c6f6d5;
      color: #22543d;
      border-bottom: 2px solid #48bb78;
    }

    /* Sai: ƒê·ªè nh·∫°t */
    .word.wrong {
      background-color: #fed7d7;
      color: #822727;
      text-decoration: line-through;
      opacity: 0.7;
    }

    /* --- BUTTONS --- */
    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 10px;
    }

    .btn {
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      min-width: 200px;
    }

    .btn-main { background: #fbbf24; color: #744210; } /* M√†u v√†ng ch·ªß ƒë·∫°o */
    .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); background: #f59e0b;}
    
    .btn-next { background: #e2e8f0; color: #4a5568; } /* M√†u x√°m cho n√∫t b√†i kh√°c */
    .btn-next:hover { background: #cbd5e0; }

    /* Khi ·ªü tr·∫°ng th√°i "L√†m l·∫°i", ƒë·ªïi m√†u n√∫t main */
    .btn-retry { background: #48bb78 !important; color: white !important; }

    .timer {
      position: absolute;
      top: 20px; right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      z-index: 10;
      font-family: monospace;
      font-size: 18px;
    }

    /* Popup k·∫øt qu·∫£ */
    .result-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center; align-items: center;
      z-index: 100;
      flex-direction: column;
    }
    .result-box {
      background: white; padding: 40px; border-radius: 20px; text-align: center;
      max-width: 400px; width: 90%;
    }
    .result-score { font-size: 60px; color: #48bb78; font-weight: bold; margin: 10px 0; }

  </style>
</head>
<body>

  <div class="app-container">
    <div class="header">
      <h1>üá´üá∑ Luy·ªán Ph√°t √Çm (Avec Ann)</h1>
    </div>

    <div class="text-display-area">
      <div class="timer" id="timer">01:00</div>
      <div id="content-wrapper">
        </div>
    </div>

    <div class="controls">
      <button id="mainBtn" class="btn btn-main">D√©marrer (B·∫Øt ƒë·∫ßu)</button>
      
      <button id="nextLessonBtn" class="btn btn-next">B√†i kh√°c ></button>
    </div>
  </div>

  <div class="result-overlay" id="resultOverlay">
    <div class="result-box">
      <h2>K·∫øt qu·∫£</h2>
      <div class="result-score" id="finalScore">--</div>
      <p id="wordCountMsg">...</p>
      <br>
      <button class="btn btn-main" onclick="closeResult()">Xem chi ti·∫øt l·ªói sai</button>
    </div>
  </div>

  <script>
    // --- N·ªòI DUNG B√ÄI ƒê·ªåC ---
    const frenchText = `
      Apprendre une nouvelle langue est comme ouvrir une fen√™tre sur un monde inconnu. 
      C‚Äôest une aventure passionnante qui demande du courage et de la patience. 
      Quand on parle fran√ßais, on d√©couvre la culture de la France, la beaut√© de Paris 
      et l‚Äôhistoire des grands √©crivains comme Victor Hugo. 
      
      Chaque jour est une opportunit√© pour progresser. 
      Il ne faut pas avoir peur de faire des erreurs, car c‚Äôest en tombant qu‚Äôon apprend √† marcher. 
      √âcoutez de la musique, regardez des films et parlez avec des amis. 
      
      Le voyage est plus important que la destination. 
      Alors, respirez profond√©ment, souriez et commencez √† lire ce texte avec confiance. 
      Votre effort aujourd'hui sera votre succ√®s de demain. 
    `;

    // Bi·∫øn h·ªá th·ªëng
    let mediaRecorder;
    let fullTranscript = ""; 
    let timerInterval, recordingInterval;
    const TIME_LIMIT = 60;
    let timeLeft = TIME_LIMIT;
    let isFinished = false;

    // DOM Elements
    const contentWrapper = document.getElementById('content-wrapper');
    const mainBtn = document.getElementById('mainBtn');
    const nextLessonBtn = document.getElementById('nextLessonBtn');
    const timerDisplay = document.getElementById('timer');
    const resultOverlay = document.getElementById('resultOverlay');

    // 1. Chu·∫©n b·ªã vƒÉn b·∫£n khi v√†o trang
    function initText() {
      const words = frenchText.trim().split(/\s+/);
      contentWrapper.innerHTML = '';
      words.forEach(word => {
        const span = document.createElement('span');
        span.className = 'word';
        span.textContent = word;
        span.dataset.clean = normalizeWord(word); 
        contentWrapper.appendChild(span);
      });
    }

    function normalizeWord(word) {
      return word.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "").replace(/\s+/g, "");
    }

    // 2. X·ª≠ l√Ω n√∫t b·∫•m ch√≠nh
    mainBtn.addEventListener('click', async () => {
      // N·∫øu b√†i ƒë√£ xong -> N√∫t n√†y ƒë√≥ng vai tr√≤ l√† "L√†m l·∫°i"
      if (isFinished) {
        location.reload(); // C√°ch s·∫°ch nh·∫•t ƒë·ªÉ reset m·ªçi th·ª©
        return;
      }

      // N·∫øu ch∆∞a xong -> N√∫t n√†y ƒë√≥ng vai tr√≤ "B·∫Øt ƒë·∫ßu"
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        startSession(stream);
      } catch (err) {
        alert("L·ªói Micro: " + err.message);
      }
    });

    // 3. Logic B·∫Øt ƒë·∫ßu
    function startSession(stream) {
      // UI Updates
      mainBtn.disabled = true;
      mainBtn.textContent = "ƒêang nghe...";
      contentWrapper.classList.add('scrolling'); // B·∫Øt ƒë·∫ßu tr√¥i ch·ªØ

      fullTranscript = "";
      
      // Setup Ghi √¢m
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) sendToIBM(e.data);
      };

      // Chunking: C·∫Øt file 3s/l·∫ßn g·ª≠i l√™n server
      mediaRecorder.start();
      recordingInterval = setInterval(() => {
        if(mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          mediaRecorder.start();
        }
      }, 3000);

      // ƒê·∫øm ng∆∞·ª£c
      timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
        if (timeLeft <= 0) finishSession();
      }, 1000);
    }

    // 4. K·∫øt th√∫c
    function finishSession() {
      // D·ª´ng logic
      clearInterval(timerInterval);
      clearInterval(recordingInterval);
      if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
      
      // UI Updates
      mainBtn.textContent = "ƒêang ch·∫•m ƒëi·ªÉm...";
      
      // QUAN TR·ªåNG: S·ª≠a l·ªói m√†n h√¨nh tr·∫Øng
      // Lo·∫°i b·ªè class scrolling ƒë·ªÉ d·ª´ng animation
      contentWrapper.classList.remove('scrolling');
      // Reset v·ªã tr√≠ ch·ªØ v·ªÅ ƒë·∫ßu trang ƒë·ªÉ ng∆∞·ªùi d√πng nh√¨n th·∫•y
      contentWrapper.style.transform = 'translateY(0)';
      contentWrapper.style.paddingTop = '50px'; // ƒê·∫©y xu·ªëng m·ªôt ch√∫t cho ƒë·∫πp

      // ƒê·ª£i 2s ƒë·ªÉ API tr·∫£ n·ªët k·∫øt qu·∫£ cu·ªëi c√πng
      setTimeout(calculateResult, 2000);
    }

    // 5. Ch·∫•m ƒëi·ªÉm & T√¥ m√†u
    function calculateResult() {
      isFinished = true;
      const allSpokenWords = fullTranscript.toLowerCase();
      const domWords = document.querySelectorAll('.word');
      let correctCount = 0;

      domWords.forEach(span => {
        const original = span.dataset.clean;
        
        // Logic t√¥ m√†u
        if (allSpokenWords.includes(original)) {
          span.classList.add('correct'); // Xanh
          correctCount++;
        } else {
          span.classList.add('wrong');   // ƒê·ªè
        }
      });

      // T√≠nh %
      const score = Math.round((correctCount / domWords.length) * 100);

      // Hi·ªán Popup
      document.getElementById('finalScore').textContent = `${score}%`;
      document.getElementById('wordCountMsg').textContent = `ƒê√∫ng ${correctCount}/${domWords.length} t·ª´`;
      resultOverlay.style.display = 'flex';

      // ƒê·ªïi n√∫t th√†nh "L√†m l·∫°i"
      mainBtn.disabled = false;
      mainBtn.textContent = "üîÑ L√†m l·∫°i b√†i n√†y";
      mainBtn.classList.add('btn-retry'); // ƒê·ªïi m√†u n√∫t sang xanh
    }

    function closeResult() {
      resultOverlay.style.display = 'none';
      // L√∫c n√†y ng∆∞·ªùi d√πng s·∫Ω nh√¨n th·∫•y vƒÉn b·∫£n ƒë√£ ƒë∆∞·ª£c t√¥ xanh/ƒë·ªè
    }

    // N√∫t B√†i kh√°c (Demo)
    nextLessonBtn.addEventListener('click', () => {
      alert("T√≠nh nƒÉng t·∫£i b√†i h·ªçc ti·∫øp theo s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t s·ªõm!");
    });

    // G·ªçi h√†m init
    initText();
    
    // G·ª≠i data (gi·ªØ nguy√™n logic c≈©)
    async function sendToIBM(blob) {
      const formData = new FormData();
      formData.append('audio', blob, 'chunk.webm');
      try {
        const res = await fetch('/api/transcribe', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.text) {
          fullTranscript += " " + data.text;
          console.log("Nghe ƒë∆∞·ª£c:", fullTranscript);
        }
      } catch (e) { console.error(e); }
    }
  </script>
</body>
</html>
